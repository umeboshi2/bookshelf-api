// Generated by CoffeeScript 1.12.6
'use strict';
var HowhapList;

HowhapList = require('howhap-list');

module.exports = function(req, res, urlPieces, model, config) {
  var hasTimestamps, list, options, promise;
  list = new HowhapList(null, {
    availableErrors: config.errors
  });
  if (config.putBehavior && config.putBehavior.toLowerCase() === 'update' && urlPieces.length < 2) {
    list.add('REQUIRES_ID', {
      model: urlPieces[0]
    });
    res.status(config.errors.REQUIRES_ID.status).json(list.toObject());
    return new Promise(function(resolve, reject) {
      resolve({
        urlPieces: urlPieces,
        model: model
      });
    });
  } else {
    options = {};
    if (config.putBehavior && config.putBehavior.toLowerCase() === 'update') {
      options.method = 'update';
    }
    promise = model;
    hasTimestamps = null;
    if (model.hasTimestamps === false) {
      hasTimestamps = [];
    } else {
      hasTimestamps = model.hasTimestamps;
    }
    if (typeof hasTimestamps === 'boolean') {
      hasTimestamps = ['created_at', 'updated_at'];
    }
    if (hasTimestamps.indexOf(config.deletedAttribute) >= 0) {
      promise = promise.where(config.deletedAttribute, null);
    }
    return promise.save(req.body, options).then(function(savedModel) {
      res.json(savedModel.toJSON());
    })["catch"](function(err) {
      var status;
      status = 500;
      if (err.message === 'No Rows Updated') {
        list.add('RECORD_NOT_FOUND', {
          model: urlPieces[0],
          id: urlPieces[1]
        });
        status = config.errors.RECORD_NOT_FOUND.status;
      } else {
        list.add('UNKNOWN', {
          error: err.toString()
        });
        status = config.errors.UNKNOWN.status;
      }
      res.status(status).json(list.toObject());
    }).then(function() {
      return Promise.resolve({
        urlPieces: urlPieces,
        model: model
      });
    });
  }
};

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHV0LmpzIiwic291cmNlUm9vdCI6Ii4uIiwic291cmNlcyI6WyJjc3JjL3B1dC5jb2ZmZWUiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBO0FBQUEsSUFBQTs7QUFDQSxVQUFBLEdBQWEsT0FBQSxDQUFRLGFBQVI7O0FBRWIsTUFBTSxDQUFDLE9BQVAsR0FBaUIsU0FBQyxHQUFELEVBQU0sR0FBTixFQUFXLFNBQVgsRUFBc0IsS0FBdEIsRUFBNkIsTUFBN0I7QUFDZixNQUFBO0VBQUEsSUFBQSxHQUFPLElBQUksVUFBSixDQUFlLElBQWYsRUFBcUI7SUFBQSxlQUFBLEVBQWlCLE1BQU0sQ0FBQyxNQUF4QjtHQUFyQjtFQUNQLElBQUcsTUFBTSxDQUFDLFdBQVAsSUFBdUIsTUFBTSxDQUFDLFdBQVcsQ0FBQyxXQUFuQixDQUFBLENBQUEsS0FBb0MsUUFBM0QsSUFBd0UsU0FBUyxDQUFDLE1BQVYsR0FBbUIsQ0FBOUY7SUFDRSxJQUFJLENBQUMsR0FBTCxDQUFTLGFBQVQsRUFBd0I7TUFBQSxLQUFBLEVBQU8sU0FBVSxDQUFBLENBQUEsQ0FBakI7S0FBeEI7SUFDQSxHQUFHLENBQUMsTUFBSixDQUFXLE1BQU0sQ0FBQyxNQUFNLENBQUMsV0FBVyxDQUFDLE1BQXJDLENBQTRDLENBQUMsSUFBN0MsQ0FBa0QsSUFBSSxDQUFDLFFBQUwsQ0FBQSxDQUFsRDtXQUNBLElBQUksT0FBSixDQUFZLFNBQUMsT0FBRCxFQUFVLE1BQVY7TUFDVixPQUFBLENBQ0U7UUFBQSxTQUFBLEVBQVcsU0FBWDtRQUNBLEtBQUEsRUFBTyxLQURQO09BREY7SUFEVSxDQUFaLEVBSEY7R0FBQSxNQUFBO0lBVUUsT0FBQSxHQUFVO0lBQ1YsSUFBRyxNQUFNLENBQUMsV0FBUCxJQUF1QixNQUFNLENBQUMsV0FBVyxDQUFDLFdBQW5CLENBQUEsQ0FBQSxLQUFvQyxRQUE5RDtNQUNFLE9BQU8sQ0FBQyxNQUFSLEdBQWlCLFNBRG5COztJQUVBLE9BQUEsR0FBVTtJQUNWLGFBQUEsR0FBZ0I7SUFDaEIsSUFBRyxLQUFLLENBQUMsYUFBTixLQUF1QixLQUExQjtNQUNFLGFBQUEsR0FBZ0IsR0FEbEI7S0FBQSxNQUFBO01BR0UsYUFBQSxHQUFnQixLQUFLLENBQUMsY0FIeEI7O0lBSUEsSUFBRyxPQUFPLGFBQVAsS0FBd0IsU0FBM0I7TUFDRSxhQUFBLEdBQWdCLENBQ2QsWUFEYyxFQUVkLFlBRmMsRUFEbEI7O0lBS0EsSUFBRyxhQUFhLENBQUMsT0FBZCxDQUFzQixNQUFNLENBQUMsZ0JBQTdCLENBQUEsSUFBa0QsQ0FBckQ7TUFDRSxPQUFBLEdBQVUsT0FBTyxDQUFDLEtBQVIsQ0FBYyxNQUFNLENBQUMsZ0JBQXJCLEVBQXVDLElBQXZDLEVBRFo7O1dBRUEsT0FBTyxDQUFDLElBQVIsQ0FBYSxHQUFHLENBQUMsSUFBakIsRUFBdUIsT0FBdkIsQ0FBK0IsQ0FBQyxJQUFoQyxDQUFxQyxTQUFDLFVBQUQ7TUFDbkMsR0FBRyxDQUFDLElBQUosQ0FBUyxVQUFVLENBQUMsTUFBWCxDQUFBLENBQVQ7SUFEbUMsQ0FBckMsQ0FHQyxFQUFDLEtBQUQsRUFIRCxDQUdRLFNBQUMsR0FBRDtBQUNOLFVBQUE7TUFBQSxNQUFBLEdBQVM7TUFDVCxJQUFHLEdBQUcsQ0FBQyxPQUFKLEtBQWUsaUJBQWxCO1FBQ0UsSUFBSSxDQUFDLEdBQUwsQ0FBUyxrQkFBVCxFQUNFO1VBQUEsS0FBQSxFQUFPLFNBQVUsQ0FBQSxDQUFBLENBQWpCO1VBQ0EsRUFBQSxFQUFJLFNBQVUsQ0FBQSxDQUFBLENBRGQ7U0FERjtRQUdBLE1BQUEsR0FBUyxNQUFNLENBQUMsTUFBTSxDQUFDLGdCQUFnQixDQUFDLE9BSjFDO09BQUEsTUFBQTtRQU1FLElBQUksQ0FBQyxHQUFMLENBQVMsU0FBVCxFQUFvQjtVQUFBLEtBQUEsRUFBTyxHQUFHLENBQUMsUUFBSixDQUFBLENBQVA7U0FBcEI7UUFDQSxNQUFBLEdBQVMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsT0FQakM7O01BUUEsR0FBRyxDQUFDLE1BQUosQ0FBVyxNQUFYLENBQWtCLENBQUMsSUFBbkIsQ0FBd0IsSUFBSSxDQUFDLFFBQUwsQ0FBQSxDQUF4QjtJQVZNLENBSFIsQ0FlQyxDQUFDLElBZkYsQ0FlTyxTQUFBO2FBQ0wsT0FBTyxDQUFDLE9BQVIsQ0FDRTtRQUFBLFNBQUEsRUFBVyxTQUFYO1FBQ0EsS0FBQSxFQUFPLEtBRFA7T0FERjtJQURLLENBZlAsRUExQkY7O0FBRmUiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCdcbkhvd2hhcExpc3QgPSByZXF1aXJlKCdob3doYXAtbGlzdCcpXG5cbm1vZHVsZS5leHBvcnRzID0gKHJlcSwgcmVzLCB1cmxQaWVjZXMsIG1vZGVsLCBjb25maWcpIC0+XG4gIGxpc3QgPSBuZXcgSG93aGFwTGlzdChudWxsLCBhdmFpbGFibGVFcnJvcnM6IGNvbmZpZy5lcnJvcnMpXG4gIGlmIGNvbmZpZy5wdXRCZWhhdmlvciBhbmQgY29uZmlnLnB1dEJlaGF2aW9yLnRvTG93ZXJDYXNlKCkgPT0gJ3VwZGF0ZScgYW5kIHVybFBpZWNlcy5sZW5ndGggPCAyXG4gICAgbGlzdC5hZGQgJ1JFUVVJUkVTX0lEJywgbW9kZWw6IHVybFBpZWNlc1swXVxuICAgIHJlcy5zdGF0dXMoY29uZmlnLmVycm9ycy5SRVFVSVJFU19JRC5zdGF0dXMpLmpzb24gbGlzdC50b09iamVjdCgpXG4gICAgbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgLT5cbiAgICAgIHJlc29sdmVcbiAgICAgICAgdXJsUGllY2VzOiB1cmxQaWVjZXNcbiAgICAgICAgbW9kZWw6IG1vZGVsXG4gICAgICByZXR1cm5cbilcbiAgZWxzZVxuICAgIG9wdGlvbnMgPSB7fVxuICAgIGlmIGNvbmZpZy5wdXRCZWhhdmlvciBhbmQgY29uZmlnLnB1dEJlaGF2aW9yLnRvTG93ZXJDYXNlKCkgPT0gJ3VwZGF0ZSdcbiAgICAgIG9wdGlvbnMubWV0aG9kID0gJ3VwZGF0ZSdcbiAgICBwcm9taXNlID0gbW9kZWxcbiAgICBoYXNUaW1lc3RhbXBzID0gbnVsbFxuICAgIGlmIG1vZGVsLmhhc1RpbWVzdGFtcHMgPT0gZmFsc2VcbiAgICAgIGhhc1RpbWVzdGFtcHMgPSBbXVxuICAgIGVsc2VcbiAgICAgIGhhc1RpbWVzdGFtcHMgPSBtb2RlbC5oYXNUaW1lc3RhbXBzXG4gICAgaWYgdHlwZW9mIGhhc1RpbWVzdGFtcHMgPT0gJ2Jvb2xlYW4nXG4gICAgICBoYXNUaW1lc3RhbXBzID0gW1xuICAgICAgICAnY3JlYXRlZF9hdCdcbiAgICAgICAgJ3VwZGF0ZWRfYXQnXG4gICAgICBdXG4gICAgaWYgaGFzVGltZXN0YW1wcy5pbmRleE9mKGNvbmZpZy5kZWxldGVkQXR0cmlidXRlKSA+PSAwXG4gICAgICBwcm9taXNlID0gcHJvbWlzZS53aGVyZShjb25maWcuZGVsZXRlZEF0dHJpYnV0ZSwgbnVsbClcbiAgICBwcm9taXNlLnNhdmUocmVxLmJvZHksIG9wdGlvbnMpLnRoZW4oKHNhdmVkTW9kZWwpIC0+XG4gICAgICByZXMuanNvbiBzYXZlZE1vZGVsLnRvSlNPTigpXG4gICAgICByZXR1cm5cbiAgICApLmNhdGNoKChlcnIpIC0+XG4gICAgICBzdGF0dXMgPSA1MDBcbiAgICAgIGlmIGVyci5tZXNzYWdlID09ICdObyBSb3dzIFVwZGF0ZWQnXG4gICAgICAgIGxpc3QuYWRkICdSRUNPUkRfTk9UX0ZPVU5EJyxcbiAgICAgICAgICBtb2RlbDogdXJsUGllY2VzWzBdXG4gICAgICAgICAgaWQ6IHVybFBpZWNlc1sxXVxuICAgICAgICBzdGF0dXMgPSBjb25maWcuZXJyb3JzLlJFQ09SRF9OT1RfRk9VTkQuc3RhdHVzXG4gICAgICBlbHNlXG4gICAgICAgIGxpc3QuYWRkICdVTktOT1dOJywgZXJyb3I6IGVyci50b1N0cmluZygpXG4gICAgICAgIHN0YXR1cyA9IGNvbmZpZy5lcnJvcnMuVU5LTk9XTi5zdGF0dXNcbiAgICAgIHJlcy5zdGF0dXMoc3RhdHVzKS5qc29uIGxpc3QudG9PYmplY3QoKVxuICAgICAgcmV0dXJuXG4gICAgKS50aGVuIC0+XG4gICAgICBQcm9taXNlLnJlc29sdmVcbiAgICAgICAgdXJsUGllY2VzOiB1cmxQaWVjZXNcbiAgICAgICAgbW9kZWw6IG1vZGVsXG4iXX0=
//# sourceURL=/freespace/home/umeboshi/workspace/bookshelf-api/csrc/put.coffee