// Generated by CoffeeScript 1.12.6
'use strict';
var HowhapList;

HowhapList = require('howhap-list');

module.exports = function(req, res, urlPieces, model, config) {
  var hasTimestamps, list, options, promise;
  list = new HowhapList(null, {
    availableErrors: config.errors
  });
  if (config.putBehavior && config.putBehavior.toLowerCase() === 'update' && urlPieces.length < 2) {
    list.add('REQUIRES_ID', {
      model: urlPieces[0]
    });
    res.status(config.errors.REQUIRES_ID.status).json(list.toObject());
    return new Promise(function(resolve, reject) {
      resolve({
        urlPieces: urlPieces,
        model: model
      });
    });
  } else {
    options = {};
    if (config.putBehavior && config.putBehavior.toLowerCase() === 'update') {
      options.method = 'update';
    }
    promise = model;
    hasTimestamps = null;
    if (model.hasTimestamps === false) {
      hasTimestamps = [];
    } else {
      hasTimestamps = model.hasTimestamps;
    }
    if (typeof hasTimestamps === 'boolean') {
      hasTimestamps = ['created_at', 'updated_at'];
    }
    if (hasTimestamps.indexOf(config.deletedAttribute) >= 0) {
      promise = promise.where(config.deletedAttribute, null);
    }
    return promise.save(req.body, options).then(function(savedModel) {
      res.json(savedModel.toJSON());
    })["catch"](function(err) {
      var status;
      status = 500;
      if (err.message === 'No Rows Updated') {
        list.add('RECORD_NOT_FOUND', {
          model: urlPieces[0],
          id: urlPieces[1]
        });
        status = config.errors.RECORD_NOT_FOUND.status;
      } else {
        list.add('UNKNOWN', {
          error: err.toString()
        });
        status = config.errors.UNKNOWN.status;
      }
      res.status(status).json(list.toObject());
    }).then(function() {
      return Promise.resolve({
        urlPieces: urlPieces,
        model: model
      });
    });
  }
};

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHV0LmpzIiwic291cmNlUm9vdCI6Ii4uIiwic291cmNlcyI6WyJzcmMvcHV0LmNvZmZlZSJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUE7QUFBQSxJQUFBOztBQUNBLFVBQUEsR0FBYSxPQUFBLENBQVEsYUFBUjs7QUFFYixNQUFNLENBQUMsT0FBUCxHQUFpQixTQUFDLEdBQUQsRUFBTSxHQUFOLEVBQVcsU0FBWCxFQUFzQixLQUF0QixFQUE2QixNQUE3QjtBQUNmLE1BQUE7RUFBQSxJQUFBLEdBQU8sSUFBSSxVQUFKLENBQWUsSUFBZixFQUFxQjtJQUFBLGVBQUEsRUFBaUIsTUFBTSxDQUFDLE1BQXhCO0dBQXJCO0VBQ1AsSUFBRyxNQUFNLENBQUMsV0FBUCxJQUF1QixNQUFNLENBQUMsV0FBVyxDQUFDLFdBQW5CLENBQUEsQ0FBQSxLQUFvQyxRQUEzRCxJQUF3RSxTQUFTLENBQUMsTUFBVixHQUFtQixDQUE5RjtJQUNFLElBQUksQ0FBQyxHQUFMLENBQVMsYUFBVCxFQUF3QjtNQUFBLEtBQUEsRUFBTyxTQUFVLENBQUEsQ0FBQSxDQUFqQjtLQUF4QjtJQUNBLEdBQUcsQ0FBQyxNQUFKLENBQVcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxXQUFXLENBQUMsTUFBckMsQ0FBNEMsQ0FBQyxJQUE3QyxDQUFrRCxJQUFJLENBQUMsUUFBTCxDQUFBLENBQWxEO1dBQ0EsSUFBSSxPQUFKLENBQVksU0FBQyxPQUFELEVBQVUsTUFBVjtNQUNWLE9BQUEsQ0FDRTtRQUFBLFNBQUEsRUFBVyxTQUFYO1FBQ0EsS0FBQSxFQUFPLEtBRFA7T0FERjtJQURVLENBQVosRUFIRjtHQUFBLE1BQUE7SUFVRSxPQUFBLEdBQVU7SUFDVixJQUFHLE1BQU0sQ0FBQyxXQUFQLElBQXVCLE1BQU0sQ0FBQyxXQUFXLENBQUMsV0FBbkIsQ0FBQSxDQUFBLEtBQW9DLFFBQTlEO01BQ0UsT0FBTyxDQUFDLE1BQVIsR0FBaUIsU0FEbkI7O0lBRUEsT0FBQSxHQUFVO0lBQ1YsYUFBQSxHQUFnQjtJQUNoQixJQUFHLEtBQUssQ0FBQyxhQUFOLEtBQXVCLEtBQTFCO01BQ0UsYUFBQSxHQUFnQixHQURsQjtLQUFBLE1BQUE7TUFHRSxhQUFBLEdBQWdCLEtBQUssQ0FBQyxjQUh4Qjs7SUFJQSxJQUFHLE9BQU8sYUFBUCxLQUF3QixTQUEzQjtNQUNFLGFBQUEsR0FBZ0IsQ0FDZCxZQURjLEVBRWQsWUFGYyxFQURsQjs7SUFLQSxJQUFHLGFBQWEsQ0FBQyxPQUFkLENBQXNCLE1BQU0sQ0FBQyxnQkFBN0IsQ0FBQSxJQUFrRCxDQUFyRDtNQUNFLE9BQUEsR0FBVSxPQUFPLENBQUMsS0FBUixDQUFjLE1BQU0sQ0FBQyxnQkFBckIsRUFBdUMsSUFBdkMsRUFEWjs7V0FFQSxPQUFPLENBQUMsSUFBUixDQUFhLEdBQUcsQ0FBQyxJQUFqQixFQUF1QixPQUF2QixDQUErQixDQUFDLElBQWhDLENBQXFDLFNBQUMsVUFBRDtNQUNuQyxHQUFHLENBQUMsSUFBSixDQUFTLFVBQVUsQ0FBQyxNQUFYLENBQUEsQ0FBVDtJQURtQyxDQUFyQyxDQUdDLEVBQUMsS0FBRCxFQUhELENBR1EsU0FBQyxHQUFEO0FBQ04sVUFBQTtNQUFBLE1BQUEsR0FBUztNQUNULElBQUcsR0FBRyxDQUFDLE9BQUosS0FBZSxpQkFBbEI7UUFDRSxJQUFJLENBQUMsR0FBTCxDQUFTLGtCQUFULEVBQ0U7VUFBQSxLQUFBLEVBQU8sU0FBVSxDQUFBLENBQUEsQ0FBakI7VUFDQSxFQUFBLEVBQUksU0FBVSxDQUFBLENBQUEsQ0FEZDtTQURGO1FBR0EsTUFBQSxHQUFTLE1BQU0sQ0FBQyxNQUFNLENBQUMsZ0JBQWdCLENBQUMsT0FKMUM7T0FBQSxNQUFBO1FBTUUsSUFBSSxDQUFDLEdBQUwsQ0FBUyxTQUFULEVBQW9CO1VBQUEsS0FBQSxFQUFPLEdBQUcsQ0FBQyxRQUFKLENBQUEsQ0FBUDtTQUFwQjtRQUNBLE1BQUEsR0FBUyxNQUFNLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxPQVBqQzs7TUFRQSxHQUFHLENBQUMsTUFBSixDQUFXLE1BQVgsQ0FBa0IsQ0FBQyxJQUFuQixDQUF3QixJQUFJLENBQUMsUUFBTCxDQUFBLENBQXhCO0lBVk0sQ0FIUixDQWVDLENBQUMsSUFmRixDQWVPLFNBQUE7YUFDTCxPQUFPLENBQUMsT0FBUixDQUNFO1FBQUEsU0FBQSxFQUFXLFNBQVg7UUFDQSxLQUFBLEVBQU8sS0FEUDtPQURGO0lBREssQ0FmUCxFQTFCRjs7QUFGZSIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0J1xuSG93aGFwTGlzdCA9IHJlcXVpcmUoJ2hvd2hhcC1saXN0JylcblxubW9kdWxlLmV4cG9ydHMgPSAocmVxLCByZXMsIHVybFBpZWNlcywgbW9kZWwsIGNvbmZpZykgLT5cbiAgbGlzdCA9IG5ldyBIb3doYXBMaXN0KG51bGwsIGF2YWlsYWJsZUVycm9yczogY29uZmlnLmVycm9ycylcbiAgaWYgY29uZmlnLnB1dEJlaGF2aW9yIGFuZCBjb25maWcucHV0QmVoYXZpb3IudG9Mb3dlckNhc2UoKSA9PSAndXBkYXRlJyBhbmQgdXJsUGllY2VzLmxlbmd0aCA8IDJcbiAgICBsaXN0LmFkZCAnUkVRVUlSRVNfSUQnLCBtb2RlbDogdXJsUGllY2VzWzBdXG4gICAgcmVzLnN0YXR1cyhjb25maWcuZXJyb3JzLlJFUVVJUkVTX0lELnN0YXR1cykuanNvbiBsaXN0LnRvT2JqZWN0KClcbiAgICBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSAtPlxuICAgICAgcmVzb2x2ZVxuICAgICAgICB1cmxQaWVjZXM6IHVybFBpZWNlc1xuICAgICAgICBtb2RlbDogbW9kZWxcbiAgICAgIHJldHVyblxuKVxuICBlbHNlXG4gICAgb3B0aW9ucyA9IHt9XG4gICAgaWYgY29uZmlnLnB1dEJlaGF2aW9yIGFuZCBjb25maWcucHV0QmVoYXZpb3IudG9Mb3dlckNhc2UoKSA9PSAndXBkYXRlJ1xuICAgICAgb3B0aW9ucy5tZXRob2QgPSAndXBkYXRlJ1xuICAgIHByb21pc2UgPSBtb2RlbFxuICAgIGhhc1RpbWVzdGFtcHMgPSBudWxsXG4gICAgaWYgbW9kZWwuaGFzVGltZXN0YW1wcyA9PSBmYWxzZVxuICAgICAgaGFzVGltZXN0YW1wcyA9IFtdXG4gICAgZWxzZVxuICAgICAgaGFzVGltZXN0YW1wcyA9IG1vZGVsLmhhc1RpbWVzdGFtcHNcbiAgICBpZiB0eXBlb2YgaGFzVGltZXN0YW1wcyA9PSAnYm9vbGVhbidcbiAgICAgIGhhc1RpbWVzdGFtcHMgPSBbXG4gICAgICAgICdjcmVhdGVkX2F0J1xuICAgICAgICAndXBkYXRlZF9hdCdcbiAgICAgIF1cbiAgICBpZiBoYXNUaW1lc3RhbXBzLmluZGV4T2YoY29uZmlnLmRlbGV0ZWRBdHRyaWJ1dGUpID49IDBcbiAgICAgIHByb21pc2UgPSBwcm9taXNlLndoZXJlKGNvbmZpZy5kZWxldGVkQXR0cmlidXRlLCBudWxsKVxuICAgIHByb21pc2Uuc2F2ZShyZXEuYm9keSwgb3B0aW9ucykudGhlbigoc2F2ZWRNb2RlbCkgLT5cbiAgICAgIHJlcy5qc29uIHNhdmVkTW9kZWwudG9KU09OKClcbiAgICAgIHJldHVyblxuICAgICkuY2F0Y2goKGVycikgLT5cbiAgICAgIHN0YXR1cyA9IDUwMFxuICAgICAgaWYgZXJyLm1lc3NhZ2UgPT0gJ05vIFJvd3MgVXBkYXRlZCdcbiAgICAgICAgbGlzdC5hZGQgJ1JFQ09SRF9OT1RfRk9VTkQnLFxuICAgICAgICAgIG1vZGVsOiB1cmxQaWVjZXNbMF1cbiAgICAgICAgICBpZDogdXJsUGllY2VzWzFdXG4gICAgICAgIHN0YXR1cyA9IGNvbmZpZy5lcnJvcnMuUkVDT1JEX05PVF9GT1VORC5zdGF0dXNcbiAgICAgIGVsc2VcbiAgICAgICAgbGlzdC5hZGQgJ1VOS05PV04nLCBlcnJvcjogZXJyLnRvU3RyaW5nKClcbiAgICAgICAgc3RhdHVzID0gY29uZmlnLmVycm9ycy5VTktOT1dOLnN0YXR1c1xuICAgICAgcmVzLnN0YXR1cyhzdGF0dXMpLmpzb24gbGlzdC50b09iamVjdCgpXG4gICAgICByZXR1cm5cbiAgICApLnRoZW4gLT5cbiAgICAgIFByb21pc2UucmVzb2x2ZVxuICAgICAgICB1cmxQaWVjZXM6IHVybFBpZWNlc1xuICAgICAgICBtb2RlbDogbW9kZWxcbiJdfQ==
//# sourceURL=/freespace/home/umeboshi/workspace/bookshelf-api/src/put.coffee