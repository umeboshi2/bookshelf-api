// Generated by CoffeeScript 1.12.6
'use strict';
var _, del, get, path, post, put, url;

_ = require('lodash');

get = require('./get');

post = require('./post');

put = require('./put');

del = require('./delete');

url = require('url');

path = require('path');

module.exports = function(models, config) {
  var middleware;
  middleware = function(req, res, next) {
    var Model, error, filteredUrlPieces, method, model, modelId, modelName, params, parsed, urlPieces;
    parsed = url.parse(_.trim(req.originalUrl, path.sep));
    urlPieces = parsed.pathname.split(path.sep);
    method = req.method.toLowerCase();
    error = function(message) {
      if (next && _.isFunction(next)) {
        next();
      }
      return Promise.reject({
        error: message
      });
    };
    if (!urlPieces.length) {
      return error('Unknown path');
    }
    modelName = null;
    modelId = null;
    if (this && this.modelName) {
      modelName = this.modelName.toLowerCase();
      if (req.params && req.params.id) {
        modelId = req.params.id;
      }
    } else if (!models.hasOwnProperty(urlPieces[urlPieces.length - 1].toLowerCase())) {
      if (urlPieces.length < 2 || !models.hasOwnProperty(urlPieces[urlPieces.length - 2].toLowerCase())) {
        return error('No match');
      } else {
        modelName = urlPieces[urlPieces.length - 2].toLowerCase();
        modelId = urlPieces[urlPieces.length - 1];
      }
    } else {
      modelName = urlPieces[urlPieces.length - 1].toLowerCase();
    }
    filteredUrlPieces = [modelName];
    Model = models[modelName];
    model = new Model;
    if (modelId !== null) {
      params = {};
      params[model.idAttribute] = modelId;
      model = Model.forge(params);
      filteredUrlPieces.push(modelId);
    }
    if (method === 'get') {
      return get(req, res, filteredUrlPieces, model, config);
    } else if (method === 'post') {
      return post(req, res, filteredUrlPieces, model, config);
    } else if (method === 'put') {
      return put(req, res, filteredUrlPieces, model, config);
    } else if (method === 'delete') {
      return del(req, res, filteredUrlPieces, model, config);
    }
  };
  return function(req, res, next) {
    if (typeof req === 'string') {
      return middleware.bind({
        modelName: req
      });
    }
    return middleware(req, res, next);
  };
};

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWlkZGxld2FyZS5qcyIsInNvdXJjZVJvb3QiOiIuLiIsInNvdXJjZXMiOlsic3JjL21pZGRsZXdhcmUuY29mZmVlIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQTtBQUFBLElBQUE7O0FBQ0EsQ0FBQSxHQUFJLE9BQUEsQ0FBUSxRQUFSOztBQUNKLEdBQUEsR0FBTSxPQUFBLENBQVEsT0FBUjs7QUFDTixJQUFBLEdBQU8sT0FBQSxDQUFRLFFBQVI7O0FBQ1AsR0FBQSxHQUFNLE9BQUEsQ0FBUSxPQUFSOztBQUNOLEdBQUEsR0FBTSxPQUFBLENBQVEsVUFBUjs7QUFDTixHQUFBLEdBQU0sT0FBQSxDQUFRLEtBQVI7O0FBQ04sSUFBQSxHQUFPLE9BQUEsQ0FBUSxNQUFSOztBQUVQLE1BQU0sQ0FBQyxPQUFQLEdBQWlCLFNBQUMsTUFBRCxFQUFTLE1BQVQ7QUFFZixNQUFBO0VBQUEsVUFBQSxHQUFhLFNBQUMsR0FBRCxFQUFNLEdBQU4sRUFBVyxJQUFYO0FBQ1gsUUFBQTtJQUFBLE1BQUEsR0FBUyxHQUFHLENBQUMsS0FBSixDQUFVLENBQUMsQ0FBQyxJQUFGLENBQU8sR0FBRyxDQUFDLFdBQVgsRUFBd0IsSUFBSSxDQUFDLEdBQTdCLENBQVY7SUFDVCxTQUFBLEdBQVksTUFBTSxDQUFDLFFBQVEsQ0FBQyxLQUFoQixDQUFzQixJQUFJLENBQUMsR0FBM0I7SUFDWixNQUFBLEdBQVMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxXQUFYLENBQUE7SUFFVCxLQUFBLEdBQVEsU0FBQyxPQUFEO01BQ04sSUFBRyxJQUFBLElBQVMsQ0FBQyxDQUFDLFVBQUYsQ0FBYSxJQUFiLENBQVo7UUFDRSxJQUFBLENBQUEsRUFERjs7YUFFQSxPQUFPLENBQUMsTUFBUixDQUFlO1FBQUEsS0FBQSxFQUFPLE9BQVA7T0FBZjtJQUhNO0lBS1IsSUFBRyxDQUFDLFNBQVMsQ0FBQyxNQUFkO0FBQ0UsYUFBTyxLQUFBLENBQU0sY0FBTixFQURUOztJQUVBLFNBQUEsR0FBWTtJQUNaLE9BQUEsR0FBVTtJQUVWLElBQUcsSUFBQSxJQUFTLElBQUMsQ0FBQSxTQUFiO01BQ0UsU0FBQSxHQUFZLElBQUMsQ0FBQSxTQUFTLENBQUMsV0FBWCxDQUFBO01BQ1osSUFBRyxHQUFHLENBQUMsTUFBSixJQUFlLEdBQUcsQ0FBQyxNQUFNLENBQUMsRUFBN0I7UUFDRSxPQUFBLEdBQVUsR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUR2QjtPQUZGO0tBQUEsTUFJSyxJQUFHLENBQUMsTUFBTSxDQUFDLGNBQVAsQ0FBc0IsU0FBVSxDQUFBLFNBQVMsQ0FBQyxNQUFWLEdBQW1CLENBQW5CLENBQXFCLENBQUMsV0FBaEMsQ0FBQSxDQUF0QixDQUFKO01BQ0gsSUFBRyxTQUFTLENBQUMsTUFBVixHQUFtQixDQUFuQixJQUF3QixDQUFDLE1BQU0sQ0FBQyxjQUFQLENBQXNCLFNBQVUsQ0FBQSxTQUFTLENBQUMsTUFBVixHQUFtQixDQUFuQixDQUFxQixDQUFDLFdBQWhDLENBQUEsQ0FBdEIsQ0FBNUI7QUFDRSxlQUFPLEtBQUEsQ0FBTSxVQUFOLEVBRFQ7T0FBQSxNQUFBO1FBR0UsU0FBQSxHQUFZLFNBQVUsQ0FBQSxTQUFTLENBQUMsTUFBVixHQUFtQixDQUFuQixDQUFxQixDQUFDLFdBQWhDLENBQUE7UUFDWixPQUFBLEdBQVUsU0FBVSxDQUFBLFNBQVMsQ0FBQyxNQUFWLEdBQW1CLENBQW5CLEVBSnRCO09BREc7S0FBQSxNQUFBO01BT0gsU0FBQSxHQUFZLFNBQVUsQ0FBQSxTQUFTLENBQUMsTUFBVixHQUFtQixDQUFuQixDQUFxQixDQUFDLFdBQWhDLENBQUEsRUFQVDs7SUFRTCxpQkFBQSxHQUFvQixDQUFFLFNBQUY7SUFDcEIsS0FBQSxHQUFRLE1BQU8sQ0FBQSxTQUFBO0lBQ2YsS0FBQSxHQUFRLElBQUk7SUFDWixJQUFHLE9BQUEsS0FBVyxJQUFkO01BQ0UsTUFBQSxHQUFTO01BQ1QsTUFBTyxDQUFBLEtBQUssQ0FBQyxXQUFOLENBQVAsR0FBNEI7TUFDNUIsS0FBQSxHQUFRLEtBQUssQ0FBQyxLQUFOLENBQVksTUFBWjtNQUNSLGlCQUFpQixDQUFDLElBQWxCLENBQXVCLE9BQXZCLEVBSkY7O0lBS0EsSUFBRyxNQUFBLEtBQVUsS0FBYjtBQUNFLGFBQU8sR0FBQSxDQUFJLEdBQUosRUFBUyxHQUFULEVBQWMsaUJBQWQsRUFBaUMsS0FBakMsRUFBd0MsTUFBeEMsRUFEVDtLQUFBLE1BRUssSUFBRyxNQUFBLEtBQVUsTUFBYjtBQUNILGFBQU8sSUFBQSxDQUFLLEdBQUwsRUFBVSxHQUFWLEVBQWUsaUJBQWYsRUFBa0MsS0FBbEMsRUFBeUMsTUFBekMsRUFESjtLQUFBLE1BRUEsSUFBRyxNQUFBLEtBQVUsS0FBYjtBQUNILGFBQU8sR0FBQSxDQUFJLEdBQUosRUFBUyxHQUFULEVBQWMsaUJBQWQsRUFBaUMsS0FBakMsRUFBd0MsTUFBeEMsRUFESjtLQUFBLE1BRUEsSUFBRyxNQUFBLEtBQVUsUUFBYjtBQUNILGFBQU8sR0FBQSxDQUFJLEdBQUosRUFBUyxHQUFULEVBQWMsaUJBQWQsRUFBaUMsS0FBakMsRUFBd0MsTUFBeEMsRUFESjs7RUF6Q007U0E2Q2IsU0FBQyxHQUFELEVBQU0sR0FBTixFQUFXLElBQVg7SUFFRSxJQUFHLE9BQU8sR0FBUCxLQUFjLFFBQWpCO0FBQ0UsYUFBTyxVQUFVLENBQUMsSUFBWCxDQUFnQjtRQUFBLFNBQUEsRUFBVyxHQUFYO09BQWhCLEVBRFQ7O1dBRUEsVUFBQSxDQUFXLEdBQVgsRUFBZ0IsR0FBaEIsRUFBcUIsSUFBckI7RUFKRjtBQS9DZSIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0J1xuXyA9IHJlcXVpcmUoJ2xvZGFzaCcpXG5nZXQgPSByZXF1aXJlKCcuL2dldCcpXG5wb3N0ID0gcmVxdWlyZSgnLi9wb3N0JylcbnB1dCA9IHJlcXVpcmUoJy4vcHV0JylcbmRlbCA9IHJlcXVpcmUoJy4vZGVsZXRlJylcbnVybCA9IHJlcXVpcmUoJ3VybCcpXG5wYXRoID0gcmVxdWlyZSgncGF0aCcpXG5cbm1vZHVsZS5leHBvcnRzID0gKG1vZGVscywgY29uZmlnKSAtPlxuXG4gIG1pZGRsZXdhcmUgPSAocmVxLCByZXMsIG5leHQpIC0+XG4gICAgcGFyc2VkID0gdXJsLnBhcnNlKF8udHJpbShyZXEub3JpZ2luYWxVcmwsIHBhdGguc2VwKSlcbiAgICB1cmxQaWVjZXMgPSBwYXJzZWQucGF0aG5hbWUuc3BsaXQocGF0aC5zZXApXG4gICAgbWV0aG9kID0gcmVxLm1ldGhvZC50b0xvd2VyQ2FzZSgpXG5cbiAgICBlcnJvciA9IChtZXNzYWdlKSAtPlxuICAgICAgaWYgbmV4dCBhbmQgXy5pc0Z1bmN0aW9uKG5leHQpXG4gICAgICAgIG5leHQoKVxuICAgICAgUHJvbWlzZS5yZWplY3QgZXJyb3I6IG1lc3NhZ2VcblxuICAgIGlmICF1cmxQaWVjZXMubGVuZ3RoXG4gICAgICByZXR1cm4gZXJyb3IoJ1Vua25vd24gcGF0aCcpXG4gICAgbW9kZWxOYW1lID0gbnVsbFxuICAgIG1vZGVsSWQgPSBudWxsXG4gICAgIyBOYW1lZCBtb2RlbFxuICAgIGlmIHRoaXMgYW5kIEBtb2RlbE5hbWVcbiAgICAgIG1vZGVsTmFtZSA9IEBtb2RlbE5hbWUudG9Mb3dlckNhc2UoKVxuICAgICAgaWYgcmVxLnBhcmFtcyBhbmQgcmVxLnBhcmFtcy5pZFxuICAgICAgICBtb2RlbElkID0gcmVxLnBhcmFtcy5pZFxuICAgIGVsc2UgaWYgIW1vZGVscy5oYXNPd25Qcm9wZXJ0eSh1cmxQaWVjZXNbdXJsUGllY2VzLmxlbmd0aCAtIDFdLnRvTG93ZXJDYXNlKCkpXG4gICAgICBpZiB1cmxQaWVjZXMubGVuZ3RoIDwgMiBvciAhbW9kZWxzLmhhc093blByb3BlcnR5KHVybFBpZWNlc1t1cmxQaWVjZXMubGVuZ3RoIC0gMl0udG9Mb3dlckNhc2UoKSlcbiAgICAgICAgcmV0dXJuIGVycm9yKCdObyBtYXRjaCcpXG4gICAgICBlbHNlXG4gICAgICAgIG1vZGVsTmFtZSA9IHVybFBpZWNlc1t1cmxQaWVjZXMubGVuZ3RoIC0gMl0udG9Mb3dlckNhc2UoKVxuICAgICAgICBtb2RlbElkID0gdXJsUGllY2VzW3VybFBpZWNlcy5sZW5ndGggLSAxXVxuICAgIGVsc2VcbiAgICAgIG1vZGVsTmFtZSA9IHVybFBpZWNlc1t1cmxQaWVjZXMubGVuZ3RoIC0gMV0udG9Mb3dlckNhc2UoKVxuICAgIGZpbHRlcmVkVXJsUGllY2VzID0gWyBtb2RlbE5hbWUgXVxuICAgIE1vZGVsID0gbW9kZWxzW21vZGVsTmFtZV1cbiAgICBtb2RlbCA9IG5ldyBNb2RlbFxuICAgIGlmIG1vZGVsSWQgIT0gbnVsbFxuICAgICAgcGFyYW1zID0ge31cbiAgICAgIHBhcmFtc1ttb2RlbC5pZEF0dHJpYnV0ZV0gPSBtb2RlbElkXG4gICAgICBtb2RlbCA9IE1vZGVsLmZvcmdlKHBhcmFtcylcbiAgICAgIGZpbHRlcmVkVXJsUGllY2VzLnB1c2ggbW9kZWxJZFxuICAgIGlmIG1ldGhvZCA9PSAnZ2V0J1xuICAgICAgcmV0dXJuIGdldChyZXEsIHJlcywgZmlsdGVyZWRVcmxQaWVjZXMsIG1vZGVsLCBjb25maWcpXG4gICAgZWxzZSBpZiBtZXRob2QgPT0gJ3Bvc3QnXG4gICAgICByZXR1cm4gcG9zdChyZXEsIHJlcywgZmlsdGVyZWRVcmxQaWVjZXMsIG1vZGVsLCBjb25maWcpXG4gICAgZWxzZSBpZiBtZXRob2QgPT0gJ3B1dCdcbiAgICAgIHJldHVybiBwdXQocmVxLCByZXMsIGZpbHRlcmVkVXJsUGllY2VzLCBtb2RlbCwgY29uZmlnKVxuICAgIGVsc2UgaWYgbWV0aG9kID09ICdkZWxldGUnXG4gICAgICByZXR1cm4gZGVsKHJlcSwgcmVzLCBmaWx0ZXJlZFVybFBpZWNlcywgbW9kZWwsIGNvbmZpZylcbiAgICByZXR1cm5cblxuICAocmVxLCByZXMsIG5leHQpIC0+XG4gICAgIyBTcGVjaWZpY2FsbHkgY2FsbGluZyBvdXQgYSBuYW1lZCBtb2RlbFxuICAgIGlmIHR5cGVvZiByZXEgPT0gJ3N0cmluZydcbiAgICAgIHJldHVybiBtaWRkbGV3YXJlLmJpbmQobW9kZWxOYW1lOiByZXEpXG4gICAgbWlkZGxld2FyZSByZXEsIHJlcywgbmV4dFxuIl19
//# sourceURL=/freespace/home/umeboshi/workspace/bookshelf-api/src/middleware.coffee