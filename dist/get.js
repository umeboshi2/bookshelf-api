// Generated by CoffeeScript 1.12.6
'use strict';
var HowhapList;

HowhapList = require('howhap-list');

module.exports = function(req, res, urlPieces, model, config) {
  var direction, fetchParams, hasTimestamps, list, promise;
  promise = model;
  list = new HowhapList(null, {
    availableErrors: config.errors
  });
  hasTimestamps = null;
  if (model.hasTimestamps === false) {
    hasTimestamps = [];
  } else {
    hasTimestamps = model.hasTimestamps;
  }
  if (typeof hasTimestamps === 'boolean') {
    hasTimestamps = ['created_at', 'updated_at'];
  }
  if (hasTimestamps.indexOf(config.deletedAttribute) !== -1) {
    promise = promise.where(config.deletedAttribute, null);
  }
  fetchParams = {};
  if (req.query && Array.isArray(req.query.withRelated)) {
    fetchParams.withRelated = req.query.withRelated;
  }
  if (urlPieces.length > 1) {
    promise = promise.fetch(fetchParams);
  } else {
    if (req.query) {
      if (req.query.where) {
        if (Array.isArray(req.query.where)) {
          promise = promise.where.apply(promise, req.query.where);
        } else if (Object.prototype.toString.call(req.query.where) === '[object Object]') {
          promise = promise.where(req.query.where);
        }
      }
      if (req.query.sort) {
        direction = req.query.direction || 'ASC';
        direction = direction.toLowerCase();
        promise = promise.query('orderBy', req.query.sort, direction);
      }
    }
    promise = promise.fetchAll(fetchParams);
  }
  return promise.then(function(results) {
    if (!results) {
      list.add('RECORD_NOT_FOUND', {
        model: urlPieces[0],
        id: urlPieces[1]
      });
      res.status(config.errors.RECORD_NOT_FOUND.status).json(list.toObject());
    } else {
      res.json(results.toJSON());
    }
  })["catch"](function(err) {
    list.add('RECORD_NOT_FOUND', {
      error: err.toString()
    });
    res.status(config.errors.UNKNOWN.status).json(list.toObject());
  }).then(function() {
    return Promise.resolve({
      urlPieces: urlPieces,
      model: model
    });
  });
};

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2V0LmpzIiwic291cmNlUm9vdCI6Ii4uIiwic291cmNlcyI6WyJjc3JjL2dldC5jb2ZmZWUiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBO0FBQUEsSUFBQTs7QUFDQSxVQUFBLEdBQWEsT0FBQSxDQUFRLGFBQVI7O0FBRWIsTUFBTSxDQUFDLE9BQVAsR0FBaUIsU0FBQyxHQUFELEVBQU0sR0FBTixFQUFXLFNBQVgsRUFBc0IsS0FBdEIsRUFBNkIsTUFBN0I7QUFDZixNQUFBO0VBQUEsT0FBQSxHQUFVO0VBQ1YsSUFBQSxHQUFPLElBQUksVUFBSixDQUFlLElBQWYsRUFBcUI7SUFBQSxlQUFBLEVBQWlCLE1BQU0sQ0FBQyxNQUF4QjtHQUFyQjtFQUNQLGFBQUEsR0FBZ0I7RUFDaEIsSUFBRyxLQUFLLENBQUMsYUFBTixLQUF1QixLQUExQjtJQUNFLGFBQUEsR0FBZ0IsR0FEbEI7R0FBQSxNQUFBO0lBR0UsYUFBQSxHQUFnQixLQUFLLENBQUMsY0FIeEI7O0VBSUEsSUFBRyxPQUFPLGFBQVAsS0FBd0IsU0FBM0I7SUFDRSxhQUFBLEdBQWdCLENBQ2QsWUFEYyxFQUVkLFlBRmMsRUFEbEI7O0VBS0EsSUFBRyxhQUFhLENBQUMsT0FBZCxDQUFzQixNQUFNLENBQUMsZ0JBQTdCLENBQUEsS0FBa0QsQ0FBQyxDQUF0RDtJQUNFLE9BQUEsR0FBVSxPQUFPLENBQUMsS0FBUixDQUFjLE1BQU0sQ0FBQyxnQkFBckIsRUFBdUMsSUFBdkMsRUFEWjs7RUFFQSxXQUFBLEdBQWM7RUFDZCxJQUFHLEdBQUcsQ0FBQyxLQUFKLElBQWMsS0FBSyxDQUFDLE9BQU4sQ0FBYyxHQUFHLENBQUMsS0FBSyxDQUFDLFdBQXhCLENBQWpCO0lBQ0UsV0FBVyxDQUFDLFdBQVosR0FBMEIsR0FBRyxDQUFDLEtBQUssQ0FBQyxZQUR0Qzs7RUFHQSxJQUFHLFNBQVMsQ0FBQyxNQUFWLEdBQW1CLENBQXRCO0lBQ0UsT0FBQSxHQUFVLE9BQU8sQ0FBQyxLQUFSLENBQWMsV0FBZCxFQURaO0dBQUEsTUFBQTtJQUdFLElBQUcsR0FBRyxDQUFDLEtBQVA7TUFFRSxJQUFHLEdBQUcsQ0FBQyxLQUFLLENBQUMsS0FBYjtRQUNFLElBQUcsS0FBSyxDQUFDLE9BQU4sQ0FBYyxHQUFHLENBQUMsS0FBSyxDQUFDLEtBQXhCLENBQUg7VUFDRSxPQUFBLEdBQVUsT0FBTyxDQUFDLEtBQUssQ0FBQyxLQUFkLENBQW9CLE9BQXBCLEVBQTZCLEdBQUcsQ0FBQyxLQUFLLENBQUMsS0FBdkMsRUFEWjtTQUFBLE1BRUssSUFBRyxNQUFNLENBQUEsU0FBRSxDQUFBLFFBQVEsQ0FBQyxJQUFqQixDQUFzQixHQUFHLENBQUMsS0FBSyxDQUFDLEtBQWhDLENBQUEsS0FBMEMsaUJBQTdDO1VBQ0gsT0FBQSxHQUFVLE9BQU8sQ0FBQyxLQUFSLENBQWMsR0FBRyxDQUFDLEtBQUssQ0FBQyxLQUF4QixFQURQO1NBSFA7O01BTUEsSUFBRyxHQUFHLENBQUMsS0FBSyxDQUFDLElBQWI7UUFDRSxTQUFBLEdBQVksR0FBRyxDQUFDLEtBQUssQ0FBQyxTQUFWLElBQXVCO1FBQ25DLFNBQUEsR0FBWSxTQUFTLENBQUMsV0FBVixDQUFBO1FBQ1osT0FBQSxHQUFVLE9BQU8sQ0FBQyxLQUFSLENBQWMsU0FBZCxFQUF5QixHQUFHLENBQUMsS0FBSyxDQUFDLElBQW5DLEVBQXlDLFNBQXpDLEVBSFo7T0FSRjs7SUFjQSxPQUFBLEdBQVUsT0FBTyxDQUFDLFFBQVIsQ0FBaUIsV0FBakIsRUFqQlo7O1NBa0JBLE9BQU8sQ0FBQyxJQUFSLENBQWEsU0FBQyxPQUFEO0lBQ1gsSUFBRyxDQUFDLE9BQUo7TUFDRSxJQUFJLENBQUMsR0FBTCxDQUFTLGtCQUFULEVBQ0U7UUFBQSxLQUFBLEVBQU8sU0FBVSxDQUFBLENBQUEsQ0FBakI7UUFDQSxFQUFBLEVBQUksU0FBVSxDQUFBLENBQUEsQ0FEZDtPQURGO01BR0EsR0FBRyxDQUFDLE1BQUosQ0FBVyxNQUFNLENBQUMsTUFBTSxDQUFDLGdCQUFnQixDQUFDLE1BQTFDLENBQWlELENBQUMsSUFBbEQsQ0FBdUQsSUFBSSxDQUFDLFFBQUwsQ0FBQSxDQUF2RCxFQUpGO0tBQUEsTUFBQTtNQU1FLEdBQUcsQ0FBQyxJQUFKLENBQVMsT0FBTyxDQUFDLE1BQVIsQ0FBQSxDQUFULEVBTkY7O0VBRFcsQ0FBYixDQVNDLEVBQUMsS0FBRCxFQVRELENBU1EsU0FBQyxHQUFEO0lBQ04sSUFBSSxDQUFDLEdBQUwsQ0FBUyxrQkFBVCxFQUE2QjtNQUFBLEtBQUEsRUFBTyxHQUFHLENBQUMsUUFBSixDQUFBLENBQVA7S0FBN0I7SUFDQSxHQUFHLENBQUMsTUFBSixDQUFXLE1BQU0sQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLE1BQWpDLENBQXdDLENBQUMsSUFBekMsQ0FBOEMsSUFBSSxDQUFDLFFBQUwsQ0FBQSxDQUE5QztFQUZNLENBVFIsQ0FhQyxDQUFDLElBYkYsQ0FhTyxTQUFBO1dBQ0wsT0FBTyxDQUFDLE9BQVIsQ0FDRTtNQUFBLFNBQUEsRUFBVyxTQUFYO01BQ0EsS0FBQSxFQUFPLEtBRFA7S0FERjtFQURLLENBYlA7QUFyQ2UiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCdcbkhvd2hhcExpc3QgPSByZXF1aXJlKCdob3doYXAtbGlzdCcpXG5cbm1vZHVsZS5leHBvcnRzID0gKHJlcSwgcmVzLCB1cmxQaWVjZXMsIG1vZGVsLCBjb25maWcpIC0+XG4gIHByb21pc2UgPSBtb2RlbFxuICBsaXN0ID0gbmV3IEhvd2hhcExpc3QobnVsbCwgYXZhaWxhYmxlRXJyb3JzOiBjb25maWcuZXJyb3JzKVxuICBoYXNUaW1lc3RhbXBzID0gbnVsbFxuICBpZiBtb2RlbC5oYXNUaW1lc3RhbXBzID09IGZhbHNlXG4gICAgaGFzVGltZXN0YW1wcyA9IFtdXG4gIGVsc2VcbiAgICBoYXNUaW1lc3RhbXBzID0gbW9kZWwuaGFzVGltZXN0YW1wc1xuICBpZiB0eXBlb2YgaGFzVGltZXN0YW1wcyA9PSAnYm9vbGVhbidcbiAgICBoYXNUaW1lc3RhbXBzID0gW1xuICAgICAgJ2NyZWF0ZWRfYXQnXG4gICAgICAndXBkYXRlZF9hdCdcbiAgICBdXG4gIGlmIGhhc1RpbWVzdGFtcHMuaW5kZXhPZihjb25maWcuZGVsZXRlZEF0dHJpYnV0ZSkgIT0gLTFcbiAgICBwcm9taXNlID0gcHJvbWlzZS53aGVyZShjb25maWcuZGVsZXRlZEF0dHJpYnV0ZSwgbnVsbClcbiAgZmV0Y2hQYXJhbXMgPSB7fVxuICBpZiByZXEucXVlcnkgYW5kIEFycmF5LmlzQXJyYXkocmVxLnF1ZXJ5LndpdGhSZWxhdGVkKVxuICAgIGZldGNoUGFyYW1zLndpdGhSZWxhdGVkID0gcmVxLnF1ZXJ5LndpdGhSZWxhdGVkXG4gICMgR2V0IGluZGl2aWR1YWwgcmVjb3JkXG4gIGlmIHVybFBpZWNlcy5sZW5ndGggPiAxXG4gICAgcHJvbWlzZSA9IHByb21pc2UuZmV0Y2goZmV0Y2hQYXJhbXMpXG4gIGVsc2VcbiAgICBpZiByZXEucXVlcnlcbiAgICAgICMgV2hlcmUgY2xhdXNlIHN1cHBvcnRcbiAgICAgIGlmIHJlcS5xdWVyeS53aGVyZVxuICAgICAgICBpZiBBcnJheS5pc0FycmF5KHJlcS5xdWVyeS53aGVyZSlcbiAgICAgICAgICBwcm9taXNlID0gcHJvbWlzZS53aGVyZS5hcHBseShwcm9taXNlLCByZXEucXVlcnkud2hlcmUpXG4gICAgICAgIGVsc2UgaWYgT2JqZWN0Ojp0b1N0cmluZy5jYWxsKHJlcS5xdWVyeS53aGVyZSkgPT0gJ1tvYmplY3QgT2JqZWN0XSdcbiAgICAgICAgICBwcm9taXNlID0gcHJvbWlzZS53aGVyZShyZXEucXVlcnkud2hlcmUpXG4gICAgICAjIE9yZGVyIGJ5IHN1cHBvcnRcbiAgICAgIGlmIHJlcS5xdWVyeS5zb3J0XG4gICAgICAgIGRpcmVjdGlvbiA9IHJlcS5xdWVyeS5kaXJlY3Rpb24gb3IgJ0FTQydcbiAgICAgICAgZGlyZWN0aW9uID0gZGlyZWN0aW9uLnRvTG93ZXJDYXNlKClcbiAgICAgICAgcHJvbWlzZSA9IHByb21pc2UucXVlcnkoJ29yZGVyQnknLCByZXEucXVlcnkuc29ydCwgZGlyZWN0aW9uKVxuICAgICAgIyBMaW1pdCBzdXBwb3J0XG4gICAgICAjIE9mZnNldCBzdXBwb3J0XG4gICAgcHJvbWlzZSA9IHByb21pc2UuZmV0Y2hBbGwoZmV0Y2hQYXJhbXMpXG4gIHByb21pc2UudGhlbigocmVzdWx0cykgLT5cbiAgICBpZiAhcmVzdWx0c1xuICAgICAgbGlzdC5hZGQgJ1JFQ09SRF9OT1RfRk9VTkQnLFxuICAgICAgICBtb2RlbDogdXJsUGllY2VzWzBdXG4gICAgICAgIGlkOiB1cmxQaWVjZXNbMV1cbiAgICAgIHJlcy5zdGF0dXMoY29uZmlnLmVycm9ycy5SRUNPUkRfTk9UX0ZPVU5ELnN0YXR1cykuanNvbiBsaXN0LnRvT2JqZWN0KClcbiAgICBlbHNlXG4gICAgICByZXMuanNvbiByZXN1bHRzLnRvSlNPTigpXG4gICAgcmV0dXJuXG4gICkuY2F0Y2goKGVycikgLT5cbiAgICBsaXN0LmFkZCAnUkVDT1JEX05PVF9GT1VORCcsIGVycm9yOiBlcnIudG9TdHJpbmcoKVxuICAgIHJlcy5zdGF0dXMoY29uZmlnLmVycm9ycy5VTktOT1dOLnN0YXR1cykuanNvbiBsaXN0LnRvT2JqZWN0KClcbiAgICByZXR1cm5cbiAgKS50aGVuIC0+XG4gICAgUHJvbWlzZS5yZXNvbHZlXG4gICAgICB1cmxQaWVjZXM6IHVybFBpZWNlc1xuICAgICAgbW9kZWw6IG1vZGVsXG4iXX0=
//# sourceURL=/freespace/home/umeboshi/workspace/bookshelf-api/csrc/get.coffee