// Generated by CoffeeScript 1.12.6
'use strict';
var HowhapList;

HowhapList = require('howhap-list');

module.exports = function(req, res, urlPieces, model, config) {
  var hasTimestamps, list, promise, result, updatedData;
  list = new HowhapList(null, {
    availableErrors: config.errors
  });
  if (urlPieces.length < 2) {
    list.add('REQUIRES_ID', {
      model: urlPieces[0]
    });
    res.status(config.errors.REQUIRES_ID.status).json(list.toObject());
    return new Promise(function(resolve, reject) {
      resolve({
        urlPieces: urlPieces,
        model: model
      });
    });
  } else {
    result = {};
    result[model.idAttribute] = model.id;
    promise = null;
    hasTimestamps = null;
    if (model.hasTimestamps === false) {
      hasTimestamps = [];
    } else {
      hasTimestamps = model.hasTimestamps;
    }
    if (typeof hasTimestamps === 'boolean') {
      hasTimestamps = ['created_at', 'updated_at'];
    }
    if (hasTimestamps.indexOf(config.deletedAttribute) >= 0 && (!req.hardDelete && !config.hardDelete || req.hardDelete === false)) {
      updatedData = {};
      updatedData[model.hasTimestamps[2]] = new Date;
      promise = model.save(updatedData, {
        method: 'update'
      }).then(function(savedModel) {
        res.json(result);
      });
    } else {
      promise = model.destroy({
        require: true
      }).then(function(destroyedModel) {
        res.json(result);
      });
    }
    return promise["catch"](function(err) {
      var status;
      status = 500;
      if (err.message === 'No Rows Updated' || err.message === 'No Rows Deleted') {
        list.add('RECORD_NOT_FOUND', {
          model: urlPieces[0],
          id: urlPieces[1]
        });
        status = config.errors.RECORD_NOT_FOUND.status;
      } else {
        list.add('UNKNOWN', {
          error: err.toString()
        });
        status = config.errors.UNKNOWN.status;
      }
      res.status(status).json(list.toObject());
    }).then(function() {
      return Promise.resolve({
        urlPieces: urlPieces,
        model: model
      });
    });
  }
};

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGVsZXRlLmpzIiwic291cmNlUm9vdCI6Ii4uIiwic291cmNlcyI6WyJjc3JjL2RlbGV0ZS5jb2ZmZWUiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBO0FBQUEsSUFBQTs7QUFDQSxVQUFBLEdBQWEsT0FBQSxDQUFRLGFBQVI7O0FBRWIsTUFBTSxDQUFDLE9BQVAsR0FBaUIsU0FBQyxHQUFELEVBQU0sR0FBTixFQUFXLFNBQVgsRUFBc0IsS0FBdEIsRUFBNkIsTUFBN0I7QUFDZixNQUFBO0VBQUEsSUFBQSxHQUFPLElBQUksVUFBSixDQUFlLElBQWYsRUFBcUI7SUFBQSxlQUFBLEVBQWlCLE1BQU0sQ0FBQyxNQUF4QjtHQUFyQjtFQUNQLElBQUcsU0FBUyxDQUFDLE1BQVYsR0FBbUIsQ0FBdEI7SUFDRSxJQUFJLENBQUMsR0FBTCxDQUFTLGFBQVQsRUFBd0I7TUFBQSxLQUFBLEVBQU8sU0FBVSxDQUFBLENBQUEsQ0FBakI7S0FBeEI7SUFDQSxHQUFHLENBQUMsTUFBSixDQUFXLE1BQU0sQ0FBQyxNQUFNLENBQUMsV0FBVyxDQUFDLE1BQXJDLENBQTRDLENBQUMsSUFBN0MsQ0FBa0QsSUFBSSxDQUFDLFFBQUwsQ0FBQSxDQUFsRDtXQUNBLElBQUksT0FBSixDQUFZLFNBQUMsT0FBRCxFQUFVLE1BQVY7TUFDVixPQUFBLENBQ0U7UUFBQSxTQUFBLEVBQVcsU0FBWDtRQUNBLEtBQUEsRUFBTyxLQURQO09BREY7SUFEVSxDQUFaLEVBSEY7R0FBQSxNQUFBO0lBVUUsTUFBQSxHQUFTO0lBQ1QsTUFBTyxDQUFBLEtBQUssQ0FBQyxXQUFOLENBQVAsR0FBNEIsS0FBSyxDQUFDO0lBQ2xDLE9BQUEsR0FBVTtJQUNWLGFBQUEsR0FBZ0I7SUFDaEIsSUFBRyxLQUFLLENBQUMsYUFBTixLQUF1QixLQUExQjtNQUNFLGFBQUEsR0FBZ0IsR0FEbEI7S0FBQSxNQUFBO01BR0UsYUFBQSxHQUFnQixLQUFLLENBQUMsY0FIeEI7O0lBSUEsSUFBRyxPQUFPLGFBQVAsS0FBd0IsU0FBM0I7TUFDRSxhQUFBLEdBQWdCLENBQ2QsWUFEYyxFQUVkLFlBRmMsRUFEbEI7O0lBS0EsSUFBRyxhQUFhLENBQUMsT0FBZCxDQUFzQixNQUFNLENBQUMsZ0JBQTdCLENBQUEsSUFBa0QsQ0FBbEQsSUFBd0QsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxVQUFMLElBQW9CLENBQUMsTUFBTSxDQUFDLFVBQTVCLElBQTBDLEdBQUcsQ0FBQyxVQUFKLEtBQWtCLEtBQTdELENBQTNEO01BQ0UsV0FBQSxHQUFjO01BQ2QsV0FBWSxDQUFBLEtBQUssQ0FBQyxhQUFjLENBQUEsQ0FBQSxDQUFwQixDQUFaLEdBQXNDLElBQUk7TUFDMUMsT0FBQSxHQUFVLEtBQUssQ0FBQyxJQUFOLENBQVcsV0FBWCxFQUF3QjtRQUFBLE1BQUEsRUFBUSxRQUFSO09BQXhCLENBQXlDLENBQUMsSUFBMUMsQ0FBK0MsU0FBQyxVQUFEO1FBQ3ZELEdBQUcsQ0FBQyxJQUFKLENBQVMsTUFBVDtNQUR1RCxDQUEvQyxFQUhaO0tBQUEsTUFBQTtNQVFFLE9BQUEsR0FBVSxLQUFLLENBQUMsT0FBTixDQUFjO1FBQUEsT0FBQSxFQUFTLElBQVQ7T0FBZCxDQUE0QixDQUFDLElBQTdCLENBQWtDLFNBQUMsY0FBRDtRQUMxQyxHQUFHLENBQUMsSUFBSixDQUFTLE1BQVQ7TUFEMEMsQ0FBbEMsRUFSWjs7V0FZQSxPQUFPLEVBQUMsS0FBRCxFQUFQLENBQWMsU0FBQyxHQUFEO0FBQ1osVUFBQTtNQUFBLE1BQUEsR0FBUztNQUNULElBQUcsR0FBRyxDQUFDLE9BQUosS0FBZSxpQkFBZixJQUFvQyxHQUFHLENBQUMsT0FBSixLQUFlLGlCQUF0RDtRQUNFLElBQUksQ0FBQyxHQUFMLENBQVMsa0JBQVQsRUFDRTtVQUFBLEtBQUEsRUFBTyxTQUFVLENBQUEsQ0FBQSxDQUFqQjtVQUNBLEVBQUEsRUFBSSxTQUFVLENBQUEsQ0FBQSxDQURkO1NBREY7UUFHQSxNQUFBLEdBQVMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxPQUoxQztPQUFBLE1BQUE7UUFNRSxJQUFJLENBQUMsR0FBTCxDQUFTLFNBQVQsRUFBb0I7VUFBQSxLQUFBLEVBQU8sR0FBRyxDQUFDLFFBQUosQ0FBQSxDQUFQO1NBQXBCO1FBQ0EsTUFBQSxHQUFTLE1BQU0sQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLE9BUGpDOztNQVFBLEdBQUcsQ0FBQyxNQUFKLENBQVcsTUFBWCxDQUFrQixDQUFDLElBQW5CLENBQXdCLElBQUksQ0FBQyxRQUFMLENBQUEsQ0FBeEI7SUFWWSxDQUFkLENBWUMsQ0FBQyxJQVpGLENBWU8sU0FBQTthQUNMLE9BQU8sQ0FBQyxPQUFSLENBQ0U7UUFBQSxTQUFBLEVBQVcsU0FBWDtRQUNBLEtBQUEsRUFBTyxLQURQO09BREY7SUFESyxDQVpQLEVBbkNGOztBQUZlIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnXG5Ib3doYXBMaXN0ID0gcmVxdWlyZSgnaG93aGFwLWxpc3QnKVxuXG5tb2R1bGUuZXhwb3J0cyA9IChyZXEsIHJlcywgdXJsUGllY2VzLCBtb2RlbCwgY29uZmlnKSAtPlxuICBsaXN0ID0gbmV3IEhvd2hhcExpc3QobnVsbCwgYXZhaWxhYmxlRXJyb3JzOiBjb25maWcuZXJyb3JzKVxuICBpZiB1cmxQaWVjZXMubGVuZ3RoIDwgMlxuICAgIGxpc3QuYWRkICdSRVFVSVJFU19JRCcsIG1vZGVsOiB1cmxQaWVjZXNbMF1cbiAgICByZXMuc3RhdHVzKGNvbmZpZy5lcnJvcnMuUkVRVUlSRVNfSUQuc3RhdHVzKS5qc29uIGxpc3QudG9PYmplY3QoKVxuICAgIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpIC0+XG4gICAgICByZXNvbHZlXG4gICAgICAgIHVybFBpZWNlczogdXJsUGllY2VzXG4gICAgICAgIG1vZGVsOiBtb2RlbFxuICAgICAgcmV0dXJuXG4pXG4gIGVsc2VcbiAgICByZXN1bHQgPSB7fVxuICAgIHJlc3VsdFttb2RlbC5pZEF0dHJpYnV0ZV0gPSBtb2RlbC5pZFxuICAgIHByb21pc2UgPSBudWxsXG4gICAgaGFzVGltZXN0YW1wcyA9IG51bGxcbiAgICBpZiBtb2RlbC5oYXNUaW1lc3RhbXBzID09IGZhbHNlXG4gICAgICBoYXNUaW1lc3RhbXBzID0gW11cbiAgICBlbHNlXG4gICAgICBoYXNUaW1lc3RhbXBzID0gbW9kZWwuaGFzVGltZXN0YW1wc1xuICAgIGlmIHR5cGVvZiBoYXNUaW1lc3RhbXBzID09ICdib29sZWFuJ1xuICAgICAgaGFzVGltZXN0YW1wcyA9IFtcbiAgICAgICAgJ2NyZWF0ZWRfYXQnXG4gICAgICAgICd1cGRhdGVkX2F0J1xuICAgICAgXVxuICAgIGlmIGhhc1RpbWVzdGFtcHMuaW5kZXhPZihjb25maWcuZGVsZXRlZEF0dHJpYnV0ZSkgPj0gMCBhbmQgKCFyZXEuaGFyZERlbGV0ZSBhbmQgIWNvbmZpZy5oYXJkRGVsZXRlIG9yIHJlcS5oYXJkRGVsZXRlID09IGZhbHNlKVxuICAgICAgdXBkYXRlZERhdGEgPSB7fVxuICAgICAgdXBkYXRlZERhdGFbbW9kZWwuaGFzVGltZXN0YW1wc1syXV0gPSBuZXcgRGF0ZVxuICAgICAgcHJvbWlzZSA9IG1vZGVsLnNhdmUodXBkYXRlZERhdGEsIG1ldGhvZDogJ3VwZGF0ZScpLnRoZW4oKHNhdmVkTW9kZWwpIC0+XG4gICAgICAgIHJlcy5qc29uIHJlc3VsdFxuICAgICAgICByZXR1cm5cbiAgICAgIClcbiAgICBlbHNlXG4gICAgICBwcm9taXNlID0gbW9kZWwuZGVzdHJveShyZXF1aXJlOiB0cnVlKS50aGVuKChkZXN0cm95ZWRNb2RlbCkgLT5cbiAgICAgICAgcmVzLmpzb24gcmVzdWx0XG4gICAgICAgIHJldHVyblxuICAgICAgKVxuICAgIHByb21pc2UuY2F0Y2goKGVycikgLT5cbiAgICAgIHN0YXR1cyA9IDUwMFxuICAgICAgaWYgZXJyLm1lc3NhZ2UgPT0gJ05vIFJvd3MgVXBkYXRlZCcgb3IgZXJyLm1lc3NhZ2UgPT0gJ05vIFJvd3MgRGVsZXRlZCdcbiAgICAgICAgbGlzdC5hZGQgJ1JFQ09SRF9OT1RfRk9VTkQnLFxuICAgICAgICAgIG1vZGVsOiB1cmxQaWVjZXNbMF1cbiAgICAgICAgICBpZDogdXJsUGllY2VzWzFdXG4gICAgICAgIHN0YXR1cyA9IGNvbmZpZy5lcnJvcnMuUkVDT1JEX05PVF9GT1VORC5zdGF0dXNcbiAgICAgIGVsc2VcbiAgICAgICAgbGlzdC5hZGQgJ1VOS05PV04nLCBlcnJvcjogZXJyLnRvU3RyaW5nKClcbiAgICAgICAgc3RhdHVzID0gY29uZmlnLmVycm9ycy5VTktOT1dOLnN0YXR1c1xuICAgICAgcmVzLnN0YXR1cyhzdGF0dXMpLmpzb24gbGlzdC50b09iamVjdCgpXG4gICAgICByZXR1cm5cbiAgICApLnRoZW4gLT5cbiAgICAgIFByb21pc2UucmVzb2x2ZVxuICAgICAgICB1cmxQaWVjZXM6IHVybFBpZWNlc1xuICAgICAgICBtb2RlbDogbW9kZWxcbiJdfQ==
//# sourceURL=/freespace/home/umeboshi/workspace/bookshelf-api/csrc/delete.coffee