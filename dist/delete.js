// Generated by CoffeeScript 1.12.6
'use strict';
var HowhapList;

HowhapList = require('howhap-list');

module.exports = function(req, res, urlPieces, model, config) {
  var hasTimestamps, list, promise, result, updatedData;
  list = new HowhapList(null, {
    availableErrors: config.errors
  });
  if (urlPieces.length < 2) {
    list.add('REQUIRES_ID', {
      model: urlPieces[0]
    });
    res.status(config.errors.REQUIRES_ID.status).json(list.toObject());
    return new Promise(function(resolve, reject) {
      resolve({
        urlPieces: urlPieces,
        model: model
      });
    });
  } else {
    result = {};
    result[model.idAttribute] = model.id;
    promise = null;
    hasTimestamps = null;
    if (model.hasTimestamps === false) {
      hasTimestamps = [];
    } else {
      hasTimestamps = model.hasTimestamps;
    }
    if (typeof hasTimestamps === 'boolean') {
      hasTimestamps = ['created_at', 'updated_at'];
    }
    if (hasTimestamps.indexOf(config.deletedAttribute) >= 0 && (!req.hardDelete && !config.hardDelete || req.hardDelete === false)) {
      updatedData = {};
      updatedData[model.hasTimestamps[2]] = new Date;
      promise = model.save(updatedData, {
        method: 'update'
      }).then(function(savedModel) {
        res.json(result);
      });
    } else {
      promise = model.destroy({
        require: true
      }).then(function(destroyedModel) {
        res.json(result);
      });
    }
    return promise["catch"](function(err) {
      var status;
      status = 500;
      if (err.message === 'No Rows Updated' || err.message === 'No Rows Deleted') {
        list.add('RECORD_NOT_FOUND', {
          model: urlPieces[0],
          id: urlPieces[1]
        });
        status = config.errors.RECORD_NOT_FOUND.status;
      } else {
        list.add('UNKNOWN', {
          error: err.toString()
        });
        status = config.errors.UNKNOWN.status;
      }
      res.status(status).json(list.toObject());
    }).then(function() {
      return Promise.resolve({
        urlPieces: urlPieces,
        model: model
      });
    });
  }
};

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGVsZXRlLmpzIiwic291cmNlUm9vdCI6Ii4uIiwic291cmNlcyI6WyJzcmMvZGVsZXRlLmNvZmZlZSJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUE7QUFBQSxJQUFBOztBQUNBLFVBQUEsR0FBYSxPQUFBLENBQVEsYUFBUjs7QUFFYixNQUFNLENBQUMsT0FBUCxHQUFpQixTQUFDLEdBQUQsRUFBTSxHQUFOLEVBQVcsU0FBWCxFQUFzQixLQUF0QixFQUE2QixNQUE3QjtBQUNmLE1BQUE7RUFBQSxJQUFBLEdBQU8sSUFBSSxVQUFKLENBQWUsSUFBZixFQUFxQjtJQUFBLGVBQUEsRUFBaUIsTUFBTSxDQUFDLE1BQXhCO0dBQXJCO0VBQ1AsSUFBRyxTQUFTLENBQUMsTUFBVixHQUFtQixDQUF0QjtJQUNFLElBQUksQ0FBQyxHQUFMLENBQVMsYUFBVCxFQUF3QjtNQUFBLEtBQUEsRUFBTyxTQUFVLENBQUEsQ0FBQSxDQUFqQjtLQUF4QjtJQUNBLEdBQUcsQ0FBQyxNQUFKLENBQVcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxXQUFXLENBQUMsTUFBckMsQ0FBNEMsQ0FBQyxJQUE3QyxDQUFrRCxJQUFJLENBQUMsUUFBTCxDQUFBLENBQWxEO1dBQ0EsSUFBSSxPQUFKLENBQVksU0FBQyxPQUFELEVBQVUsTUFBVjtNQUNWLE9BQUEsQ0FDRTtRQUFBLFNBQUEsRUFBVyxTQUFYO1FBQ0EsS0FBQSxFQUFPLEtBRFA7T0FERjtJQURVLENBQVosRUFIRjtHQUFBLE1BQUE7SUFVRSxNQUFBLEdBQVM7SUFDVCxNQUFPLENBQUEsS0FBSyxDQUFDLFdBQU4sQ0FBUCxHQUE0QixLQUFLLENBQUM7SUFDbEMsT0FBQSxHQUFVO0lBQ1YsYUFBQSxHQUFnQjtJQUNoQixJQUFHLEtBQUssQ0FBQyxhQUFOLEtBQXVCLEtBQTFCO01BQ0UsYUFBQSxHQUFnQixHQURsQjtLQUFBLE1BQUE7TUFHRSxhQUFBLEdBQWdCLEtBQUssQ0FBQyxjQUh4Qjs7SUFJQSxJQUFHLE9BQU8sYUFBUCxLQUF3QixTQUEzQjtNQUNFLGFBQUEsR0FBZ0IsQ0FDZCxZQURjLEVBRWQsWUFGYyxFQURsQjs7SUFLQSxJQUFHLGFBQWEsQ0FBQyxPQUFkLENBQXNCLE1BQU0sQ0FBQyxnQkFBN0IsQ0FBQSxJQUFrRCxDQUFsRCxJQUF3RCxDQUFDLENBQUMsR0FBRyxDQUFDLFVBQUwsSUFBb0IsQ0FBQyxNQUFNLENBQUMsVUFBNUIsSUFBMEMsR0FBRyxDQUFDLFVBQUosS0FBa0IsS0FBN0QsQ0FBM0Q7TUFDRSxXQUFBLEdBQWM7TUFDZCxXQUFZLENBQUEsS0FBSyxDQUFDLGFBQWMsQ0FBQSxDQUFBLENBQXBCLENBQVosR0FBc0MsSUFBSTtNQUMxQyxPQUFBLEdBQVUsS0FBSyxDQUFDLElBQU4sQ0FBVyxXQUFYLEVBQXdCO1FBQUEsTUFBQSxFQUFRLFFBQVI7T0FBeEIsQ0FBeUMsQ0FBQyxJQUExQyxDQUErQyxTQUFDLFVBQUQ7UUFDdkQsR0FBRyxDQUFDLElBQUosQ0FBUyxNQUFUO01BRHVELENBQS9DLEVBSFo7S0FBQSxNQUFBO01BUUUsT0FBQSxHQUFVLEtBQUssQ0FBQyxPQUFOLENBQWM7UUFBQSxPQUFBLEVBQVMsSUFBVDtPQUFkLENBQTRCLENBQUMsSUFBN0IsQ0FBa0MsU0FBQyxjQUFEO1FBQzFDLEdBQUcsQ0FBQyxJQUFKLENBQVMsTUFBVDtNQUQwQyxDQUFsQyxFQVJaOztXQVlBLE9BQU8sRUFBQyxLQUFELEVBQVAsQ0FBYyxTQUFDLEdBQUQ7QUFDWixVQUFBO01BQUEsTUFBQSxHQUFTO01BQ1QsSUFBRyxHQUFHLENBQUMsT0FBSixLQUFlLGlCQUFmLElBQW9DLEdBQUcsQ0FBQyxPQUFKLEtBQWUsaUJBQXREO1FBQ0UsSUFBSSxDQUFDLEdBQUwsQ0FBUyxrQkFBVCxFQUNFO1VBQUEsS0FBQSxFQUFPLFNBQVUsQ0FBQSxDQUFBLENBQWpCO1VBQ0EsRUFBQSxFQUFJLFNBQVUsQ0FBQSxDQUFBLENBRGQ7U0FERjtRQUdBLE1BQUEsR0FBUyxNQUFNLENBQUMsTUFBTSxDQUFDLGdCQUFnQixDQUFDLE9BSjFDO09BQUEsTUFBQTtRQU1FLElBQUksQ0FBQyxHQUFMLENBQVMsU0FBVCxFQUFvQjtVQUFBLEtBQUEsRUFBTyxHQUFHLENBQUMsUUFBSixDQUFBLENBQVA7U0FBcEI7UUFDQSxNQUFBLEdBQVMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsT0FQakM7O01BUUEsR0FBRyxDQUFDLE1BQUosQ0FBVyxNQUFYLENBQWtCLENBQUMsSUFBbkIsQ0FBd0IsSUFBSSxDQUFDLFFBQUwsQ0FBQSxDQUF4QjtJQVZZLENBQWQsQ0FZQyxDQUFDLElBWkYsQ0FZTyxTQUFBO2FBQ0wsT0FBTyxDQUFDLE9BQVIsQ0FDRTtRQUFBLFNBQUEsRUFBVyxTQUFYO1FBQ0EsS0FBQSxFQUFPLEtBRFA7T0FERjtJQURLLENBWlAsRUFuQ0Y7O0FBRmUiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCdcbkhvd2hhcExpc3QgPSByZXF1aXJlKCdob3doYXAtbGlzdCcpXG5cbm1vZHVsZS5leHBvcnRzID0gKHJlcSwgcmVzLCB1cmxQaWVjZXMsIG1vZGVsLCBjb25maWcpIC0+XG4gIGxpc3QgPSBuZXcgSG93aGFwTGlzdChudWxsLCBhdmFpbGFibGVFcnJvcnM6IGNvbmZpZy5lcnJvcnMpXG4gIGlmIHVybFBpZWNlcy5sZW5ndGggPCAyXG4gICAgbGlzdC5hZGQgJ1JFUVVJUkVTX0lEJywgbW9kZWw6IHVybFBpZWNlc1swXVxuICAgIHJlcy5zdGF0dXMoY29uZmlnLmVycm9ycy5SRVFVSVJFU19JRC5zdGF0dXMpLmpzb24gbGlzdC50b09iamVjdCgpXG4gICAgbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgLT5cbiAgICAgIHJlc29sdmVcbiAgICAgICAgdXJsUGllY2VzOiB1cmxQaWVjZXNcbiAgICAgICAgbW9kZWw6IG1vZGVsXG4gICAgICByZXR1cm5cbilcbiAgZWxzZVxuICAgIHJlc3VsdCA9IHt9XG4gICAgcmVzdWx0W21vZGVsLmlkQXR0cmlidXRlXSA9IG1vZGVsLmlkXG4gICAgcHJvbWlzZSA9IG51bGxcbiAgICBoYXNUaW1lc3RhbXBzID0gbnVsbFxuICAgIGlmIG1vZGVsLmhhc1RpbWVzdGFtcHMgPT0gZmFsc2VcbiAgICAgIGhhc1RpbWVzdGFtcHMgPSBbXVxuICAgIGVsc2VcbiAgICAgIGhhc1RpbWVzdGFtcHMgPSBtb2RlbC5oYXNUaW1lc3RhbXBzXG4gICAgaWYgdHlwZW9mIGhhc1RpbWVzdGFtcHMgPT0gJ2Jvb2xlYW4nXG4gICAgICBoYXNUaW1lc3RhbXBzID0gW1xuICAgICAgICAnY3JlYXRlZF9hdCdcbiAgICAgICAgJ3VwZGF0ZWRfYXQnXG4gICAgICBdXG4gICAgaWYgaGFzVGltZXN0YW1wcy5pbmRleE9mKGNvbmZpZy5kZWxldGVkQXR0cmlidXRlKSA+PSAwIGFuZCAoIXJlcS5oYXJkRGVsZXRlIGFuZCAhY29uZmlnLmhhcmREZWxldGUgb3IgcmVxLmhhcmREZWxldGUgPT0gZmFsc2UpXG4gICAgICB1cGRhdGVkRGF0YSA9IHt9XG4gICAgICB1cGRhdGVkRGF0YVttb2RlbC5oYXNUaW1lc3RhbXBzWzJdXSA9IG5ldyBEYXRlXG4gICAgICBwcm9taXNlID0gbW9kZWwuc2F2ZSh1cGRhdGVkRGF0YSwgbWV0aG9kOiAndXBkYXRlJykudGhlbigoc2F2ZWRNb2RlbCkgLT5cbiAgICAgICAgcmVzLmpzb24gcmVzdWx0XG4gICAgICAgIHJldHVyblxuICAgICAgKVxuICAgIGVsc2VcbiAgICAgIHByb21pc2UgPSBtb2RlbC5kZXN0cm95KHJlcXVpcmU6IHRydWUpLnRoZW4oKGRlc3Ryb3llZE1vZGVsKSAtPlxuICAgICAgICByZXMuanNvbiByZXN1bHRcbiAgICAgICAgcmV0dXJuXG4gICAgICApXG4gICAgcHJvbWlzZS5jYXRjaCgoZXJyKSAtPlxuICAgICAgc3RhdHVzID0gNTAwXG4gICAgICBpZiBlcnIubWVzc2FnZSA9PSAnTm8gUm93cyBVcGRhdGVkJyBvciBlcnIubWVzc2FnZSA9PSAnTm8gUm93cyBEZWxldGVkJ1xuICAgICAgICBsaXN0LmFkZCAnUkVDT1JEX05PVF9GT1VORCcsXG4gICAgICAgICAgbW9kZWw6IHVybFBpZWNlc1swXVxuICAgICAgICAgIGlkOiB1cmxQaWVjZXNbMV1cbiAgICAgICAgc3RhdHVzID0gY29uZmlnLmVycm9ycy5SRUNPUkRfTk9UX0ZPVU5ELnN0YXR1c1xuICAgICAgZWxzZVxuICAgICAgICBsaXN0LmFkZCAnVU5LTk9XTicsIGVycm9yOiBlcnIudG9TdHJpbmcoKVxuICAgICAgICBzdGF0dXMgPSBjb25maWcuZXJyb3JzLlVOS05PV04uc3RhdHVzXG4gICAgICByZXMuc3RhdHVzKHN0YXR1cykuanNvbiBsaXN0LnRvT2JqZWN0KClcbiAgICAgIHJldHVyblxuICAgICkudGhlbiAtPlxuICAgICAgUHJvbWlzZS5yZXNvbHZlXG4gICAgICAgIHVybFBpZWNlczogdXJsUGllY2VzXG4gICAgICAgIG1vZGVsOiBtb2RlbFxuIl19
//# sourceURL=/freespace/home/umeboshi/workspace/bookshelf-api/src/delete.coffee