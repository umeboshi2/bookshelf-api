// Generated by CoffeeScript 1.12.6
'use strict';
var Howhap, _, errors, fs, getStack, path, pluralize;

_ = require('lodash');

path = require('path');

fs = require('fs');

Howhap = require('howhap');

errors = require('./errors');

getStack = require('./get-stack');

pluralize = require('pluralize');

module.exports = function(config) {
  var callingFilePath, defaultConfig, e, files, models, originalPath, stack;
  if (!_.isObject(config)) {
    throw new Howhap(errors.BAD_CONFIG);
  }
  defaultConfig = {
    putBehavior: 'upsert',
    hardDelete: false,
    deletedAttribute: 'deletedAt',
    errors: errors,
    pluralEndpoints: false
  };
  config = _.extend(defaultConfig, config);
  if (!config.path) {
    throw new Howhap(config.errors.MISSING_PATH);
  }
  originalPath = config.path;
  if (!path.isAbsolute(config.path)) {
    stack = getStack();
    stack.shift();
    callingFilePath = stack.shift().getFileName();
    config.path = path.join(path.dirname(callingFilePath), config.path);
  }
  files = null;
  try {
    files = fs.readdirSync(config.path);
  } catch (error) {
    e = error;
    if (e.code === 'ENOENT') {
      throw new Howhap(config.errors.BAD_PATH, {
        path: originalPath
      });
    }
    throw new Howhap(config.errors.UNKNOWN, {
      error: e.toString()
    });
  }
  models = files.filter(function(file) {
    return path.extname(file) === '.js' && file.charAt(0) !== '.';
  }).map(function(file) {
    var modelName;
    modelName = file.split('.')[0];
    return {
      model: require(path.join(config.path, file)),
      name: config.pluralEndpoints ? pluralize(modelName) : modelName
    };
  }).reduce((function(before, info) {
    before[info.name.toLowerCase()] = info.model;
    return before;
  }), {});
  return require('./middleware')(models, config);
};

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiLi4iLCJzb3VyY2VzIjpbImNzcmMvaW5kZXguY29mZmVlIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQTtBQUFBLElBQUE7O0FBQ0EsQ0FBQSxHQUFJLE9BQUEsQ0FBUSxRQUFSOztBQUNKLElBQUEsR0FBTyxPQUFBLENBQVEsTUFBUjs7QUFDUCxFQUFBLEdBQUssT0FBQSxDQUFRLElBQVI7O0FBQ0wsTUFBQSxHQUFTLE9BQUEsQ0FBUSxRQUFSOztBQUNULE1BQUEsR0FBUyxPQUFBLENBQVEsVUFBUjs7QUFDVCxRQUFBLEdBQVcsT0FBQSxDQUFRLGFBQVI7O0FBQ1gsU0FBQSxHQUFZLE9BQUEsQ0FBUSxXQUFSOztBQUVaLE1BQU0sQ0FBQyxPQUFQLEdBQWlCLFNBQUMsTUFBRDtBQUNmLE1BQUE7RUFBQSxJQUFHLENBQUMsQ0FBQyxDQUFDLFFBQUYsQ0FBVyxNQUFYLENBQUo7QUFDRSxVQUFNLElBQUksTUFBSixDQUFXLE1BQU0sQ0FBQyxVQUFsQixFQURSOztFQUVBLGFBQUEsR0FDRTtJQUFBLFdBQUEsRUFBYSxRQUFiO0lBQ0EsVUFBQSxFQUFZLEtBRFo7SUFFQSxnQkFBQSxFQUFrQixXQUZsQjtJQUdBLE1BQUEsRUFBUSxNQUhSO0lBSUEsZUFBQSxFQUFpQixLQUpqQjs7RUFLRixNQUFBLEdBQVMsQ0FBQyxDQUFDLE1BQUYsQ0FBUyxhQUFULEVBQXdCLE1BQXhCO0VBQ1QsSUFBRyxDQUFDLE1BQU0sQ0FBQyxJQUFYO0FBQ0UsVUFBTSxJQUFJLE1BQUosQ0FBVyxNQUFNLENBQUMsTUFBTSxDQUFDLFlBQXpCLEVBRFI7O0VBRUEsWUFBQSxHQUFlLE1BQU0sQ0FBQztFQUV0QixJQUFHLENBQUMsSUFBSSxDQUFDLFVBQUwsQ0FBZ0IsTUFBTSxDQUFDLElBQXZCLENBQUo7SUFDRSxLQUFBLEdBQVEsUUFBQSxDQUFBO0lBQ1IsS0FBSyxDQUFDLEtBQU4sQ0FBQTtJQUNBLGVBQUEsR0FBa0IsS0FBSyxDQUFDLEtBQU4sQ0FBQSxDQUFhLENBQUMsV0FBZCxDQUFBO0lBQ2xCLE1BQU0sQ0FBQyxJQUFQLEdBQWMsSUFBSSxDQUFDLElBQUwsQ0FBVSxJQUFJLENBQUMsT0FBTCxDQUFhLGVBQWIsQ0FBVixFQUF5QyxNQUFNLENBQUMsSUFBaEQsRUFKaEI7O0VBS0EsS0FBQSxHQUFRO0FBQ1I7SUFDRSxLQUFBLEdBQVEsRUFBRSxDQUFDLFdBQUgsQ0FBZSxNQUFNLENBQUMsSUFBdEIsRUFEVjtHQUFBLGFBQUE7SUFFTTtJQUNKLElBQUcsQ0FBQyxDQUFDLElBQUYsS0FBVSxRQUFiO0FBQ0UsWUFBTSxJQUFJLE1BQUosQ0FBVyxNQUFNLENBQUMsTUFBTSxDQUFDLFFBQXpCLEVBQW1DO1FBQUEsSUFBQSxFQUFNLFlBQU47T0FBbkMsRUFEUjs7QUFFQSxVQUFNLElBQUksTUFBSixDQUFXLE1BQU0sQ0FBQyxNQUFNLENBQUMsT0FBekIsRUFBa0M7TUFBQSxLQUFBLEVBQU8sQ0FBQyxDQUFDLFFBQUYsQ0FBQSxDQUFQO0tBQWxDLEVBTFI7O0VBTUEsTUFBQSxHQUFTLEtBQUssQ0FBQyxNQUFOLENBQWEsU0FBQyxJQUFEO1dBRXBCLElBQUksQ0FBQyxPQUFMLENBQWEsSUFBYixDQUFBLEtBQXNCLEtBQXRCLElBQWdDLElBQUksQ0FBQyxNQUFMLENBQVksQ0FBWixDQUFBLEtBQWtCO0VBRjlCLENBQWIsQ0FHUixDQUFDLEdBSE8sQ0FHSCxTQUFDLElBQUQ7QUFDSixRQUFBO0lBQUEsU0FBQSxHQUFZLElBQUksQ0FBQyxLQUFMLENBQVcsR0FBWCxDQUFnQixDQUFBLENBQUE7V0FDNUI7TUFDRSxLQUFBLEVBQU8sT0FBQSxDQUFRLElBQUksQ0FBQyxJQUFMLENBQVUsTUFBTSxDQUFDLElBQWpCLEVBQXVCLElBQXZCLENBQVIsQ0FEVDtNQUVFLElBQUEsRUFBUyxNQUFNLENBQUMsZUFBVixHQUErQixTQUFBLENBQVUsU0FBVixDQUEvQixHQUF5RCxTQUZqRTs7RUFGSSxDQUhHLENBU1IsQ0FBQyxNQVRPLENBU0EsQ0FBQyxTQUFDLE1BQUQsRUFBUyxJQUFUO0lBQ1IsTUFBTyxDQUFBLElBQUksQ0FBQyxJQUFJLENBQUMsV0FBVixDQUFBLENBQUEsQ0FBUCxHQUFrQyxJQUFJLENBQUM7V0FDdkM7RUFGUSxDQUFELENBVEEsRUFZTixFQVpNO1NBYVQsT0FBQSxDQUFRLGNBQVIsQ0FBQSxDQUF3QixNQUF4QixFQUFnQyxNQUFoQztBQXZDZSIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0J1xuXyA9IHJlcXVpcmUoJ2xvZGFzaCcpXG5wYXRoID0gcmVxdWlyZSgncGF0aCcpXG5mcyA9IHJlcXVpcmUoJ2ZzJylcbkhvd2hhcCA9IHJlcXVpcmUoJ2hvd2hhcCcpXG5lcnJvcnMgPSByZXF1aXJlKCcuL2Vycm9ycycpXG5nZXRTdGFjayA9IHJlcXVpcmUoJy4vZ2V0LXN0YWNrJylcbnBsdXJhbGl6ZSA9IHJlcXVpcmUoJ3BsdXJhbGl6ZScpXG5cbm1vZHVsZS5leHBvcnRzID0gKGNvbmZpZykgLT5cbiAgaWYgIV8uaXNPYmplY3QoY29uZmlnKVxuICAgIHRocm93IG5ldyBIb3doYXAoZXJyb3JzLkJBRF9DT05GSUcpXG4gIGRlZmF1bHRDb25maWcgPSBcbiAgICBwdXRCZWhhdmlvcjogJ3Vwc2VydCdcbiAgICBoYXJkRGVsZXRlOiBmYWxzZVxuICAgIGRlbGV0ZWRBdHRyaWJ1dGU6ICdkZWxldGVkQXQnXG4gICAgZXJyb3JzOiBlcnJvcnNcbiAgICBwbHVyYWxFbmRwb2ludHM6IGZhbHNlXG4gIGNvbmZpZyA9IF8uZXh0ZW5kKGRlZmF1bHRDb25maWcsIGNvbmZpZylcbiAgaWYgIWNvbmZpZy5wYXRoXG4gICAgdGhyb3cgbmV3IEhvd2hhcChjb25maWcuZXJyb3JzLk1JU1NJTkdfUEFUSClcbiAgb3JpZ2luYWxQYXRoID0gY29uZmlnLnBhdGhcbiAgIyBSZWxhdGl2ZSBwYXRoXG4gIGlmICFwYXRoLmlzQWJzb2x1dGUoY29uZmlnLnBhdGgpXG4gICAgc3RhY2sgPSBnZXRTdGFjaygpXG4gICAgc3RhY2suc2hpZnQoKVxuICAgIGNhbGxpbmdGaWxlUGF0aCA9IHN0YWNrLnNoaWZ0KCkuZ2V0RmlsZU5hbWUoKVxuICAgIGNvbmZpZy5wYXRoID0gcGF0aC5qb2luKHBhdGguZGlybmFtZShjYWxsaW5nRmlsZVBhdGgpLCBjb25maWcucGF0aClcbiAgZmlsZXMgPSBudWxsXG4gIHRyeVxuICAgIGZpbGVzID0gZnMucmVhZGRpclN5bmMoY29uZmlnLnBhdGgpXG4gIGNhdGNoIGVcbiAgICBpZiBlLmNvZGUgPT0gJ0VOT0VOVCdcbiAgICAgIHRocm93IG5ldyBIb3doYXAoY29uZmlnLmVycm9ycy5CQURfUEFUSCwgcGF0aDogb3JpZ2luYWxQYXRoKVxuICAgIHRocm93IG5ldyBIb3doYXAoY29uZmlnLmVycm9ycy5VTktOT1dOLCBlcnJvcjogZS50b1N0cmluZygpKVxuICBtb2RlbHMgPSBmaWxlcy5maWx0ZXIoKGZpbGUpIC0+XG4gICAgIyBJZ25vcmUgbm9uLWphdmFzY3JpcHQgZmlsZXMgYW5kIGhpZGRlbiBmaWxlcy5cbiAgICBwYXRoLmV4dG5hbWUoZmlsZSkgPT0gJy5qcycgYW5kIGZpbGUuY2hhckF0KDApICE9ICcuJ1xuICApLm1hcCgoZmlsZSkgLT5cbiAgICBtb2RlbE5hbWUgPSBmaWxlLnNwbGl0KCcuJylbMF1cbiAgICB7XG4gICAgICBtb2RlbDogcmVxdWlyZShwYXRoLmpvaW4oY29uZmlnLnBhdGgsIGZpbGUpKVxuICAgICAgbmFtZTogaWYgY29uZmlnLnBsdXJhbEVuZHBvaW50cyB0aGVuIHBsdXJhbGl6ZShtb2RlbE5hbWUpIGVsc2UgbW9kZWxOYW1lXG4gICAgfVxuICApLnJlZHVjZSgoKGJlZm9yZSwgaW5mbykgLT5cbiAgICBiZWZvcmVbaW5mby5uYW1lLnRvTG93ZXJDYXNlKCldID0gaW5mby5tb2RlbFxuICAgIGJlZm9yZVxuICApLCB7fSlcbiAgcmVxdWlyZSgnLi9taWRkbGV3YXJlJykgbW9kZWxzLCBjb25maWdcbiJdfQ==
//# sourceURL=/freespace/home/umeboshi/workspace/bookshelf-api/csrc/index.coffee