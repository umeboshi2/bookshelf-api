// Generated by CoffeeScript 1.12.6
'use strict';
var Howhap, _, errors, fs, getStack, path, pluralize;

_ = require('lodash');

path = require('path');

fs = require('fs');

Howhap = require('howhap');

errors = require('./errors');

getStack = require('./get-stack');

pluralize = require('pluralize');

module.exports = function(config) {
  var callingFilePath, defaultConfig, e, files, models, originalPath, stack;
  if (!_.isObject(config)) {
    throw new Howhap(errors.BAD_CONFIG);
  }
  defaultConfig = {
    putBehavior: 'upsert',
    hardDelete: false,
    deletedAttribute: 'deletedAt',
    errors: errors,
    pluralEndpoints: false
  };
  config = _.extend(defaultConfig, config);
  if (!config.models) {
    if (!config.path) {
      throw new Howhap(config.errors.MISSING_PATH);
    }
    originalPath = config.path;
    if (!path.isAbsolute(config.path)) {
      stack = getStack();
      stack.shift();
      callingFilePath = stack.shift().getFileName();
      config.path = path.join(path.dirname(callingFilePath), config.path);
    }
    files = null;
    try {
      files = fs.readdirSync(config.path);
    } catch (error) {
      e = error;
      if (e.code === 'ENOENT') {
        throw new Howhap(config.errors.BAD_PATH, {
          path: originalPath
        });
      }
      throw new Howhap(config.errors.UNKNOWN, {
        error: e.toString()
      });
    }
    models = files.filter(function(file) {
      return path.extname(file) === '.js' && file.charAt(0) !== '.';
    }).map(function(file) {
      var modelName;
      modelName = file.split('.')[0];
      return {
        model: require(path.join(config.path, file)),
        name: config.pluralEndpoints ? pluralize(modelName) : modelName
      };
    }).reduce((function(before, info) {
      before[info.name.toLowerCase()] = info.model;
      return before;
    }), {});
  } else {
    models = config.models;
  }
  return require('./middleware')(models, config);
};

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiLi4iLCJzb3VyY2VzIjpbImNzcmMvaW5kZXguY29mZmVlIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQTtBQUFBLElBQUE7O0FBQ0EsQ0FBQSxHQUFJLE9BQUEsQ0FBUSxRQUFSOztBQUNKLElBQUEsR0FBTyxPQUFBLENBQVEsTUFBUjs7QUFDUCxFQUFBLEdBQUssT0FBQSxDQUFRLElBQVI7O0FBQ0wsTUFBQSxHQUFTLE9BQUEsQ0FBUSxRQUFSOztBQUNULE1BQUEsR0FBUyxPQUFBLENBQVEsVUFBUjs7QUFDVCxRQUFBLEdBQVcsT0FBQSxDQUFRLGFBQVI7O0FBQ1gsU0FBQSxHQUFZLE9BQUEsQ0FBUSxXQUFSOztBQUVaLE1BQU0sQ0FBQyxPQUFQLEdBQWlCLFNBQUMsTUFBRDtBQUNmLE1BQUE7RUFBQSxJQUFHLENBQUMsQ0FBQyxDQUFDLFFBQUYsQ0FBVyxNQUFYLENBQUo7QUFDRSxVQUFNLElBQUksTUFBSixDQUFXLE1BQU0sQ0FBQyxVQUFsQixFQURSOztFQUVBLGFBQUEsR0FDRTtJQUFBLFdBQUEsRUFBYSxRQUFiO0lBQ0EsVUFBQSxFQUFZLEtBRFo7SUFFQSxnQkFBQSxFQUFrQixXQUZsQjtJQUdBLE1BQUEsRUFBUSxNQUhSO0lBSUEsZUFBQSxFQUFpQixLQUpqQjs7RUFLRixNQUFBLEdBQVMsQ0FBQyxDQUFDLE1BQUYsQ0FBUyxhQUFULEVBQXdCLE1BQXhCO0VBQ1QsSUFBRyxDQUFDLE1BQU0sQ0FBQyxNQUFYO0lBQ0UsSUFBRyxDQUFDLE1BQU0sQ0FBQyxJQUFYO0FBQ0UsWUFBTSxJQUFJLE1BQUosQ0FBVyxNQUFNLENBQUMsTUFBTSxDQUFDLFlBQXpCLEVBRFI7O0lBRUEsWUFBQSxHQUFlLE1BQU0sQ0FBQztJQUV0QixJQUFHLENBQUMsSUFBSSxDQUFDLFVBQUwsQ0FBZ0IsTUFBTSxDQUFDLElBQXZCLENBQUo7TUFDRSxLQUFBLEdBQVEsUUFBQSxDQUFBO01BQ1IsS0FBSyxDQUFDLEtBQU4sQ0FBQTtNQUNBLGVBQUEsR0FBa0IsS0FBSyxDQUFDLEtBQU4sQ0FBQSxDQUFhLENBQUMsV0FBZCxDQUFBO01BQ2xCLE1BQU0sQ0FBQyxJQUFQLEdBQWMsSUFBSSxDQUFDLElBQUwsQ0FBVSxJQUFJLENBQUMsT0FBTCxDQUFhLGVBQWIsQ0FBVixFQUF5QyxNQUFNLENBQUMsSUFBaEQsRUFKaEI7O0lBS0EsS0FBQSxHQUFRO0FBQ1I7TUFDRSxLQUFBLEdBQVEsRUFBRSxDQUFDLFdBQUgsQ0FBZSxNQUFNLENBQUMsSUFBdEIsRUFEVjtLQUFBLGFBQUE7TUFFTTtNQUNKLElBQUcsQ0FBQyxDQUFDLElBQUYsS0FBVSxRQUFiO0FBQ0UsY0FBTSxJQUFJLE1BQUosQ0FBVyxNQUFNLENBQUMsTUFBTSxDQUFDLFFBQXpCLEVBQW1DO1VBQUEsSUFBQSxFQUFNLFlBQU47U0FBbkMsRUFEUjs7QUFFQSxZQUFNLElBQUksTUFBSixDQUFXLE1BQU0sQ0FBQyxNQUFNLENBQUMsT0FBekIsRUFBa0M7UUFBQSxLQUFBLEVBQU8sQ0FBQyxDQUFDLFFBQUYsQ0FBQSxDQUFQO09BQWxDLEVBTFI7O0lBTUEsTUFBQSxHQUFTLEtBQUssQ0FBQyxNQUFOLENBQWEsU0FBQyxJQUFEO2FBRXBCLElBQUksQ0FBQyxPQUFMLENBQWEsSUFBYixDQUFBLEtBQXNCLEtBQXRCLElBQWdDLElBQUksQ0FBQyxNQUFMLENBQVksQ0FBWixDQUFBLEtBQWtCO0lBRjlCLENBQWIsQ0FHUixDQUFDLEdBSE8sQ0FHSCxTQUFDLElBQUQ7QUFDSixVQUFBO01BQUEsU0FBQSxHQUFZLElBQUksQ0FBQyxLQUFMLENBQVcsR0FBWCxDQUFnQixDQUFBLENBQUE7YUFDNUI7UUFDRSxLQUFBLEVBQU8sT0FBQSxDQUFRLElBQUksQ0FBQyxJQUFMLENBQVUsTUFBTSxDQUFDLElBQWpCLEVBQXVCLElBQXZCLENBQVIsQ0FEVDtRQUVFLElBQUEsRUFBUyxNQUFNLENBQUMsZUFBVixHQUErQixTQUFBLENBQVUsU0FBVixDQUEvQixHQUF5RCxTQUZqRTs7SUFGSSxDQUhHLENBU1IsQ0FBQyxNQVRPLENBU0EsQ0FBQyxTQUFDLE1BQUQsRUFBUyxJQUFUO01BQ1IsTUFBTyxDQUFBLElBQUksQ0FBQyxJQUFJLENBQUMsV0FBVixDQUFBLENBQUEsQ0FBUCxHQUFrQyxJQUFJLENBQUM7YUFDdkM7SUFGUSxDQUFELENBVEEsRUFZTixFQVpNLEVBakJYO0dBQUEsTUFBQTtJQStCRSxNQUFBLEdBQVMsTUFBTSxDQUFDLE9BL0JsQjs7U0FnQ0EsT0FBQSxDQUFRLGNBQVIsQ0FBQSxDQUF3QixNQUF4QixFQUFnQyxNQUFoQztBQTFDZSIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0J1xuXyA9IHJlcXVpcmUoJ2xvZGFzaCcpXG5wYXRoID0gcmVxdWlyZSgncGF0aCcpXG5mcyA9IHJlcXVpcmUoJ2ZzJylcbkhvd2hhcCA9IHJlcXVpcmUoJ2hvd2hhcCcpXG5lcnJvcnMgPSByZXF1aXJlKCcuL2Vycm9ycycpXG5nZXRTdGFjayA9IHJlcXVpcmUoJy4vZ2V0LXN0YWNrJylcbnBsdXJhbGl6ZSA9IHJlcXVpcmUoJ3BsdXJhbGl6ZScpXG5cbm1vZHVsZS5leHBvcnRzID0gKGNvbmZpZykgLT5cbiAgaWYgIV8uaXNPYmplY3QoY29uZmlnKVxuICAgIHRocm93IG5ldyBIb3doYXAoZXJyb3JzLkJBRF9DT05GSUcpXG4gIGRlZmF1bHRDb25maWcgPVxuICAgIHB1dEJlaGF2aW9yOiAndXBzZXJ0J1xuICAgIGhhcmREZWxldGU6IGZhbHNlXG4gICAgZGVsZXRlZEF0dHJpYnV0ZTogJ2RlbGV0ZWRBdCdcbiAgICBlcnJvcnM6IGVycm9yc1xuICAgIHBsdXJhbEVuZHBvaW50czogZmFsc2VcbiAgY29uZmlnID0gXy5leHRlbmQoZGVmYXVsdENvbmZpZywgY29uZmlnKVxuICBpZiAhY29uZmlnLm1vZGVsc1xuICAgIGlmICFjb25maWcucGF0aFxuICAgICAgdGhyb3cgbmV3IEhvd2hhcChjb25maWcuZXJyb3JzLk1JU1NJTkdfUEFUSClcbiAgICBvcmlnaW5hbFBhdGggPSBjb25maWcucGF0aFxuICAgICMgUmVsYXRpdmUgcGF0aFxuICAgIGlmICFwYXRoLmlzQWJzb2x1dGUoY29uZmlnLnBhdGgpXG4gICAgICBzdGFjayA9IGdldFN0YWNrKClcbiAgICAgIHN0YWNrLnNoaWZ0KClcbiAgICAgIGNhbGxpbmdGaWxlUGF0aCA9IHN0YWNrLnNoaWZ0KCkuZ2V0RmlsZU5hbWUoKVxuICAgICAgY29uZmlnLnBhdGggPSBwYXRoLmpvaW4ocGF0aC5kaXJuYW1lKGNhbGxpbmdGaWxlUGF0aCksIGNvbmZpZy5wYXRoKVxuICAgIGZpbGVzID0gbnVsbFxuICAgIHRyeVxuICAgICAgZmlsZXMgPSBmcy5yZWFkZGlyU3luYyhjb25maWcucGF0aClcbiAgICBjYXRjaCBlXG4gICAgICBpZiBlLmNvZGUgPT0gJ0VOT0VOVCdcbiAgICAgICAgdGhyb3cgbmV3IEhvd2hhcChjb25maWcuZXJyb3JzLkJBRF9QQVRILCBwYXRoOiBvcmlnaW5hbFBhdGgpXG4gICAgICB0aHJvdyBuZXcgSG93aGFwKGNvbmZpZy5lcnJvcnMuVU5LTk9XTiwgZXJyb3I6IGUudG9TdHJpbmcoKSlcbiAgICBtb2RlbHMgPSBmaWxlcy5maWx0ZXIoKGZpbGUpIC0+XG4gICAgICAjIElnbm9yZSBub24tamF2YXNjcmlwdCBmaWxlcyBhbmQgaGlkZGVuIGZpbGVzLlxuICAgICAgcGF0aC5leHRuYW1lKGZpbGUpID09ICcuanMnIGFuZCBmaWxlLmNoYXJBdCgwKSAhPSAnLidcbiAgICApLm1hcCgoZmlsZSkgLT5cbiAgICAgIG1vZGVsTmFtZSA9IGZpbGUuc3BsaXQoJy4nKVswXVxuICAgICAge1xuICAgICAgICBtb2RlbDogcmVxdWlyZShwYXRoLmpvaW4oY29uZmlnLnBhdGgsIGZpbGUpKVxuICAgICAgICBuYW1lOiBpZiBjb25maWcucGx1cmFsRW5kcG9pbnRzIHRoZW4gcGx1cmFsaXplKG1vZGVsTmFtZSkgZWxzZSBtb2RlbE5hbWVcbiAgICAgIH1cbiAgICApLnJlZHVjZSgoKGJlZm9yZSwgaW5mbykgLT5cbiAgICAgIGJlZm9yZVtpbmZvLm5hbWUudG9Mb3dlckNhc2UoKV0gPSBpbmZvLm1vZGVsXG4gICAgICBiZWZvcmVcbiAgICApLCB7fSlcbiAgZWxzZVxuICAgIG1vZGVscyA9IGNvbmZpZy5tb2RlbHNcbiAgcmVxdWlyZSgnLi9taWRkbGV3YXJlJykgbW9kZWxzLCBjb25maWdcbiJdfQ==
//# sourceURL=/freespace/home/umeboshi/workspace/bookshelf-api/csrc/index.coffee